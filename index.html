<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <!-- Google Apps Script specific mobile meta tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <title>Market Activation System - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Google Apps Script Mobile Responsive Fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        /* Google Apps Script Mobile Responsive Fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --accent: #EA4335;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 400px;
            width: 100%;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            background: var(--primary);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .login-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .login-header i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .login-body {
            padding: 40px 30px;
        }

        .form-floating {
            margin-bottom: 20px;
        }

        .form-floating .form-control {
            border-radius: 10px;
            border: 2px solid #e1e5e9;
            height: 58px;
        }

        .form-floating .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(66, 133, 244, 0.25);
        }

        .login-btn {
            background: var(--primary);
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.3);
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .forgot-password {
            color: var(--primary);
            text-decoration: none;
        }

        .forgot-password:hover {
            color: #3367d6;
            text-decoration: underline;
        }

        .demo-credentials {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .demo-credentials .title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .demo-credentials .credential {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .error-message {
            color: var(--accent);
            font-size: 0.85rem;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        .success-message {
            color: var(--secondary);
            font-size: 0.85rem;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.5rem;
        }

        /* Google Apps Script Mobile Device Class Override */
        .mobile-device .sidebar {
            transform: translateX(-100%) !important;
            width: 100% !important;
            max-width: 280px !important;
        }

        .mobile-device .sidebar.active {
            transform: translateX(0) !important;
        }

        .mobile-device .content-area {
            margin-left: 0 !important;
            width: 100% !important;
            padding: 10px !important;
        }

        .mobile-device .table {
            font-size: 0.65rem !important;
        }

        .mobile-device .table th,
        .mobile-device .table td {
            font-size: 0.65rem !important;
            padding: 4px 6px !important;
        }

        .mobile-device .container-fluid {
            padding: 0 8px !important;
        }

        .mobile-device input,
        .mobile-device select,
        .mobile-device textarea {
            font-size: 16px !important;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            background-color: white;
            width: 250px;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            height: calc(100vh - 70px);
            position: fixed;
            overflow-y: auto;
            z-index: 99;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
            width: calc(100% - 250px);
            overflow-y: auto;
        }

        .sidebar .nav-link {
            color: var(--dark);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--primary);
            color: white;
        }

        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: transform 0.3s;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0 !important;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .table th {
            background-color: var(--light);
            font-weight: 600;
            white-space: nowrap;
        }

        .form-section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
        }

        .btn-primary {
            background-color: var(--primary);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #3367d6;
        }

        .location-badge {
            background-color: #e8f0fe;
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
            white-space: nowrap;
        }

        .dashboard-section {
            margin-bottom: 30px;
        }

        .section-title {
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .stylist-code {
            font-family: monospace;
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Enhanced table styling */
        .table th {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .table th:hover {
            background-color: #f8f9fa;
        }

        .table th i.fas {
            font-size: 0.7rem;
            margin-left: 5px;
            opacity: 0.6;
        }

        .btn-group .btn {
            padding: 0.25rem 0.4rem;
        }

        .stat-card {
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .stat-card .card-body {
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .table-dark th {
            background-color: var(--dark) !important;
            color: white !important;
            border-color: var(--dark) !important;
        }

        /* Enhanced form styling */
        .form-section .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .form-section .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
        }

        .card-header.bg-gradient {
            border: none;
            position: relative;
            overflow: hidden;
        }

        .card-header.bg-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .card-header.bg-gradient:hover::before {
            left: 100%;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-lg {
            padding: 0.75rem 2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-title {
            position: relative;
            padding-left: 20px;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 30px;
            background: linear-gradient(135deg, var(--primary), #667eea);
            border-radius: 2px;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 98;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 101;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content-area {
                margin-left: 0;
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .table th,
            .table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 768px) {
            .content-area {
                padding: 12px;
            }

            .form-section {
                padding: 18px;
                margin-bottom: 20px;
            }

            .stat-card .value {
                font-size: 1.4rem;
            }

            .card-header {
                padding: 12px 15px;
                font-size: 0.95rem;
            }

            /* Tablet table adjustments */
            .table th,
            .table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            /* Tablet form adjustments */
            .form-control,
            .form-select {
                font-size: 16px;
                padding: 10px 12px;
            }

            /* Tablet button adjustments */
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            /* Mobile charts */
            .chart-container {
                height: 250px !important;
                margin-bottom: 20px;
            }

            /* Mobile modal adjustments */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
        }

        @media (max-width: 576px) {
            .content-area {
                padding: 8px;
            }

            .form-section {
                padding: 12px;
            }

            /* Mobile table responsiveness */
            .table-responsive {
                font-size: 0.75rem;
                border-radius: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table th,
            .table td {
                padding: 6px 8px;
                font-size: 0.75rem;
                white-space: nowrap;
                min-width: 80px;
            }

            /* Mobile cards */
            .card {
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .card-header {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            /* Mobile stats cards */
            .stat-card {
                padding: 15px;
                text-align: center;
            }

            .stat-card .value {
                font-size: 1.3rem;
                margin: 8px 0;
            }

            .stat-card .label {
                font-size: 0.8rem;
            }

            /* Mobile forms */
            .form-control,
            .form-select {
                font-size: 16px;
                /* Prevents zoom on iOS */
                padding: 12px 15px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            /* Mobile buttons */
            .btn-sm {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            /* Mobile sidebar */
            .sidebar {
                width: 280px;
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            }

            /* Mobile header */
            .header {
                padding: 10px 15px;
            }

            /* Mobile navigation */
            .nav-link {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            /* Critical mobile viewport fixes */
            body {
                overflow-x: hidden !important;
            }

            /* Mobile input zoom prevention */
            input,
            select,
            textarea {
                font-size: 16px !important;
                -webkit-appearance: none;
                appearance: none;
                transform: scale(1);
            }

            /* Touch-friendly interactions */
            .btn,
            .form-control,
            .nav-link {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Mobile grid responsiveness */
            .container-fluid {
                padding: 0 8px;
            }

            .row {
                margin-left: -5px;
                margin-right: -5px;
            }

            .col-lg-3,
            .col-md-6,
            .col-12 {
                padding-left: 5px;
                padding-right: 5px;
                margin-bottom: 10px;
            }

            /* Mobile table improvements */
            .table {
                font-size: 0.7rem !important;
            }

            .table th,
            .table td {
                font-size: 0.7rem !important;
                padding: 4px 6px !important;
                white-space: nowrap;
            }
        }

        /* Extra small devices (360px and below) */
        @media (max-width: 360px) {
            .content-area {
                padding: 5px !important;
            }

            .card-header {
                font-size: 0.8rem !important;
                padding: 8px 10px !important;
            }

            .table th,
            .table td {
                font-size: 0.65rem !important;
                padding: 3px 4px !important;
                min-width: 50px !important;
            }

            .stat-card .value {
                font-size: 1.1rem !important;
            }

            .form-section {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }

            .btn {
                font-size: 0.8rem !important;
                padding: 8px 12px !important;
            }
        }

        .table-responsive {
            font-size: 0.85rem;
        }

        .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-braille"></i>
                <h1>Market Activation System</h1>
                <p class="mb-0">Secure Access Portal</p>
            </div>
            <div class="login-body">
                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="username" placeholder="Username" required>
                        <label for="username"><i class="fas fa-user me-2"></i>Username</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="password" placeholder="Password" required>
                        <label for="password"><i class="fas fa-lock me-2"></i>Password</label>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="rememberMe">
                        <label class="form-check-label" for="rememberMe">
                            Remember me
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary login-btn">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </button>

                    <div class="text-center mt-3">
                        <a href="#" onclick="showForgotPasswordModal(); return false;" class="text-decoration-none">
                            <i class="fas fa-key me-1"></i>Forgot Password?
                        </a>
                    </div>
                </form>

                <!-- Error/Success Messages -->
                <div class="error-message" id="errorMessage">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorText"></span>
                </div>

                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successText"></span>
                </div>

                <!-- Demo Info -->
                <div class="demo-credentials">
                    <div class="title"><i class="fas fa-info-circle me-2"></i>Demo Credentials</div>
                    <div class="credential">
                        <span>Admin:</span>
                        <strong>admin / admin123</strong>
                    </div>
                    <div class="credential">
                        <span>Manager:</span>
                        <strong>manager / manager123</strong>
                    </div>
                    <div class="credential">
                        <span>User:</span>
                        <strong>user / user123</strong>
                    </div>
                </div>

                <!-- reCAPTCHA Container (hidden, used for OTP verification) -->
                <div id="recaptcha-container" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (Hidden Initially) -->
    <div id="mainDashboard" class="dashboard-container" style="display: flex;">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container-fluid">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#">
                    <i class="fas fa-braille text-primary me-2"></i>
                    Market Activation System
                </a>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">Welcome, <span id="currentUser">Admin</span></span>
                    <button class="btn btn-outline-primary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#register-stylist">
                            <i class="fas fa-user-plus"></i> Register Stylist
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#braiding-form">
                            <i class="fas fa-cut"></i> Braiding Form
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#stylists">
                            <i class="fas fa-users"></i> Stylists
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#customers">
                            <i class="fas fa-user-friends"></i> Customers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#payments">
                            <i class="fas fa-money-bill-wave"></i> Payments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#reports">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#user-management">
                            <i class="fas fa-user-cog"></i> User Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#settings">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Sidebar overlay for mobile -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard" class="dashboard-section" style="display: block;">
                    <h2 class="section-title">Management Dashboard</h2>

                    <!-- Stats Cards -->
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-users fa-2x text-primary"></i>
                                    <div class="value">0</div>
                                    <div class="label">Stylists Registered</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-cut fa-2x text-success"></i>
                                    <div class="value">0</div>
                                    <div class="label">Braiding Completed</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-money-bill-wave fa-2x text-warning"></i>
                                    <div class="value">₦0</div>
                                    <div class="label">Total Payment</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-clock fa-2x text-danger"></i>
                                    <div class="value">₦0</div>
                                    <div class="label">Payment Pending</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Summary Table -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="fas fa-map-marker-alt me-2"></i> Location Summary
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="locationSummary">
                                    <thead>
                                        <tr>
                                            <th>Location</th>
                                            <th>Stylists Registered</th>
                                            <th>Braiding Completed</th>
                                            <th>No. of Days</th>
                                            <th>Total Payment</th>
                                            <th>Payment Done</th>
                                            <th>Payment Pending</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin"></i> Loading location data from
                                                Firebase...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="row mt-4 g-3">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-pie me-2"></i> Braiding Distribution by Location
                                </div>
                                <div class="card-body">
                                    <canvas id="locationChart" height="312"
                                        style="display: block; box-sizing: border-box; height: 250px; width: 575.4px;"
                                        width="719"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-line me-2"></i> Daily Braiding Progress
                                </div>
                                <div class="card-body">
                                    <canvas id="dailyChart" height="312" width="719"
                                        style="display: block; box-sizing: border-box; height: 250px; width: 575.4px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Register Stylist Form -->
                <div id="register-stylist" class="form-section" style="display: none;">
                    <h2 class="section-title">Register Stylist</h2>
                    <p class="text-muted mb-4">Register stylist with their basic details and assign a unique code</p>

                    <form id="stylistForm" autocomplete="off">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stylistName" class="form-label">Stylist Name</label>
                                    <input type="text" class="form-control" name="stylistName" id="stylistName" required
                                        pattern="[A-Za-z ]+" title="Only alphabets and spaces allowed">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="tel" class="form-control" name="phoneNumber" id="phoneNumber"
                                            required pattern="0[789][0-9]{9}" maxlength="11" minlength="11"
                                            title="Mobile number must be exactly 11 digits and start with 07, 08, or 09"
                                            placeholder="Must start with 07, 08, or 09">
                                        <span id="phoneLoader" style="display:none;font-size:1.1em;">⏳</span>
                                    </div>

                                    <!-- OTP functionality disabled for testing -->
                                    <!-- <div id="stylistOTPSection" class="mt-3" style="display: none;"> ... </div> -->

                                    <!-- Phone verification disabled -->
                                    <!-- <div id="stylistPhoneVerified" class="mt-2" style="display: none;"> ... </div> -->
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stylistLocation" class="form-label">Stylist Location</label>
                                    <input type="text" class="form-control" name="stylistLocation" id="stylistLocation"
                                        required list="stylistLocationDatalist"
                                        placeholder="Select location from list (required)">
                                    <datalist id="stylistLocationDatalist">
                                        <option value="OJA OBA MARKET AKURE"></option>
                                        <option value="ONDO MARKET"></option>
                                        <option value="OJA OBA MARKET, ADO - EKITI"></option>
                                        <option value="OJA TUNTUN, ILORIN"></option>
                                        <option value="ORISUNBARE MARKET, OSOGBO"></option>
                                    </datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stylistCode" class="form-label">Stylist Code</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="text" class="form-control" name="stylistCode" id="stylistCode"
                                            required pattern="[A-Za-z][0-9]{3}" maxlength="4" minlength="4"
                                            title="First letter, then 3 digits (e.g. A001)"
                                            placeholder="e.g. A001 (required)">
                                        <span id="stylistCodeLoader" style="display:none;font-size:1.1em;">⏳</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bankName" class="form-label">Bank Name</label>
                                    <input type="text" class="form-control" name="bankName" id="bankName" required
                                        pattern="[A-Za-z ]+" title="Only alphabets and spaces allowed">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bankAccountNumber" class="form-label">Bank Account Number</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="text" class="form-control" name="bankAccountNumber"
                                            id="bankAccountNumber" required pattern="[0-9]{10}" maxlength="10"
                                            minlength="10" title="Account number must be exactly 10 digits"
                                            placeholder="Enter 10 digit account number (required)">
                                        <span id="bankLoader" style="display:none;font-size:1.1em;">⏳</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 flex-wrap mt-4">
                            <button type="submit" class="btn btn-primary" id="registerStylistBtn">Register
                                Stylist</button>
                            <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
                        </div>
                    </form>

                    <div id="stylistResult" class="mt-3" style="display: none;">
                        <div class="alert" role="alert"></div>
                    </div>
                </div>

                <!-- Braiding Completion Form -->
                <div id="braiding-form" class="form-section" style="display: none;">
                    <h2 class="section-title">Customer Registration</h2>
                    <p class="text-muted mb-4">Register new customers for branding activation and track their details
                    </p>

                    <form id="geoForm" autocomplete="off">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerStylishCode" class="form-label">Stylish Code</label>
                                    <input type="text" name="stylishCode" class="form-control" required
                                        list="stylishCodeDatalist" id="customerStylishCodeInput"
                                        placeholder="Select code from list (required)">
                                    <datalist id="stylishCodeDatalist"></datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerStylishName" class="form-label">Stylish Name</label>
                                    <input type="text" name="stylishName" class="form-control" required
                                        pattern="[A-Za-z ]+" title="Only alphabets and spaces allowed" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerStylistLocation" class="form-label">Stylist Location</label>
                                    <input type="text" name="customerstylistLocation" id="customerStylistLocation"
                                        class="form-control" required list="customerLocationDatalist" readonly>
                                    <datalist id="customerLocationDatalist"></datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">Customer Name</label>
                                    <input type="text" name="customerName" class="form-control" required
                                        pattern="[A-Za-z ]+" title="Only alphabets and spaces allowed">
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerNumber" class="form-label">Customer Number</label>
                                    <input type="tel" name="customerNumber" class="form-control" required
                                        pattern="0[789][0-9]{9}" maxlength="11" minlength="11"
                                        title="Mobile number must be exactly 11 digits and start with 07, 08, or 09"
                                        inputmode="numeric" placeholder="Must start with 07, 08, or 09">

                                    <!-- OTP functionality disabled for testing -->
                                    <!-- <div id="customerOTPSection" class="mt-3" style="display: none;"> ... </div> -->

                                    <!-- Phone verification disabled -->
                                    <!-- <div id="customerPhoneVerified" class="mt-2" style="display: none;"> ... </div> -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerEmail" class="form-label">Email (Optional)</label>
                                    <input type="email" name="customerEmail" class="form-control"
                                        placeholder="customer@example.com">
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="timestamp" id="customerTimestamp">
                        <input type="hidden" name="geoLocation" id="customerGeoLocation">

                        <div class="d-flex gap-2 flex-wrap mt-4">
                            <button type="submit" class="btn btn-primary" id="registerCustomerBtn">
                                Register Customer
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
                        </div>
                    </form>

                    <div id="customerResult" class="mt-3" style="display: none;">
                        <div class="alert" role="alert"></div>
                    </div>
                </div>

                <div id="stylists" class="dashboard-section" style="display: none;">
                    <h2 class="section-title">Registered Stylists</h2>

                    <!-- Statistics Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-users fa-lg text-primary"></i>
                                    <div class="value text-primary" id="totalStylists">0</div>
                                    <div class="label">Total Stylists</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-user-check fa-lg text-success"></i>
                                    <div class="value text-success" id="activeStylists">0</div>
                                    <div class="label">Active Stylists</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-map-marker-alt fa-lg text-info"></i>
                                    <div class="value text-info" id="totalLocations">0</div>
                                    <div class="label">Locations</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-calendar-plus fa-lg text-warning"></i>
                                    <div class="value text-warning" id="newStylists">0</div>
                                    <div class="label">This Month</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-users me-2"></i> Stylists Directory
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshStylists()">
                                        <i class="fas fa-refresh"></i> Refresh
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="exportStylists()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <!-- Search and Filter Bar -->
                            <div class="mt-3">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" class="form-control" id="stylistSearch"
                                                placeholder="Search stylists..." onkeyup="filterStylists()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="locationFilter" onchange="filterStylists()">
                                            <option value="">All Locations</option>
                                            <option value="OJA OBA MARKET AKURE">OJA OBA MARKET AKURE</option>
                                            <option value="ONDO MARKET">ONDO MARKET</option>
                                            <option value="OJA OBA MARKET, ADO - EKITI">OJA OBA MARKET, ADO - EKITI
                                            </option>
                                            <option value="OJA TUNTUN, ILORIN">OJA TUNTUN, ILORIN</option>
                                            <option value="ORISUNBARE MARKET, OSOGBO">ORISUNBARE MARKET, OSOGBO</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="statusFilter" onchange="filterStylists()">
                                            <option value="">All Status</option>
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                            <option value="Suspended">Suspended</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                            <i class="fas fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="stylistsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th onclick="sortTable(0)">Stylist Code <i class="fas fa-sort"></i></th>
                                            <th onclick="sortTable(1)">Name <i class="fas fa-sort"></i></th>
                                            <th onclick="sortTable(2)">Phone <i class="fas fa-sort"></i></th>
                                            <th onclick="sortTable(3)">Location <i class="fas fa-sort"></i></th>
                                            <th onclick="sortTable(4)">Registration Date <i class="fas fa-sort"></i>
                                            </th>
                                            <th onclick="sortTable(5)">Status <i class="fas fa-sort"></i></th>
                                            <th>Performance</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stylistsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">Loading stylists from
                                                Firebase...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="payments" class="dashboard-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Payment Tracking</h2>
                        <div>
                            <input type="file" id="csvUpload" accept=".csv" style="display: none;" />
                            <button class="btn btn-primary" onclick="document.getElementById('csvUpload').click()">
                                <i class="fas fa-upload me-2"></i>Upload Payment CSV
                            </button>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-money-bill-wave fa-lg text-success"></i>
                                    <div class="value text-success" id="totalPaid">₦0</div>
                                    <div class="label">Total Paid</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-clock fa-lg text-warning"></i>
                                    <div class="value text-warning" id="totalPending">₦0</div>
                                    <div class="label">Pending Payments</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-percentage fa-lg text-info"></i>
                                    <div class="value text-info">0%</div>
                                    <div class="label">Collection Rate</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-calendar-day fa-lg text-primary"></i>
                                    <div class="value text-primary">₦0</div>
                                    <div class="label">This Month</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-receipt me-2"></i> Recent Payment Transactions
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Stylist</th>
                                            <th>Client</th>
                                            <th>Service</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Method</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">Loading payment records...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reports" class="dashboard-section" style="display: none;">
                    <h2 class="section-title">Reports & Analytics</h2>

                    <div class="row g-3">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-line me-2"></i> Revenue Trends
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-star me-2"></i> Top Performing Stylists
                                </div>
                                <div class="card-body">
                                    <div id="topStylists">
                                        <div class="text-center text-muted py-4">
                                            No performance data available
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Data Section -->
                <div id="customers" class="dashboard-section" style="display: none;">
                    <h2 class="section-title">Customer Data</h2>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-users fa-lg text-primary"></i>
                                    <div class="value text-primary" id="totalCustomers">0</div>
                                    <div class="label">Total Customers</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-calendar-day fa-lg text-success"></i>
                                    <div class="value text-success" id="todayCustomers">0</div>
                                    <div class="label">Today's Registrations</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-chart-line fa-lg text-info"></i>
                                    <div class="value text-info" id="weeklyCustomers">0</div>
                                    <div class="label">This Week</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-calendar-alt fa-lg text-warning"></i>
                                    <div class="value text-warning" id="monthlyCustomers">0</div>
                                    <div class="label">This Month</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-users me-2"></i> Customer Directory
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshCustomers()">
                                        <i class="fas fa-refresh"></i> Refresh
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="exportCustomers()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="customersTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Customer Name</th>
                                            <th>Phone Number</th>
                                            <th>Stylist Code</th>
                                            <th>Stylist Name</th>
                                            <th>Location</th>
                                            <th>Registration Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customersTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">Loading customers...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="user-management" class="dashboard-section" style="display: none;">
                    <h2 class="section-title">User Management</h2>
                    <p class="text-muted mb-4">Manage user access, roles, and permissions for the system</p>

                    <!-- User Statistics -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-users fa-lg text-primary"></i>
                                    <div class="value text-primary" id="totalUsers">0</div>
                                    <div class="label">Total Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-user-check fa-lg text-success"></i>
                                    <div class="value text-success" id="activeUsers">0</div>
                                    <div class="label">Active Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-user-clock fa-lg text-warning"></i>
                                    <div class="value text-warning" id="pendingUsers">0</div>
                                    <div class="label">Pending Approval</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="fas fa-user-times fa-lg text-danger"></i>
                                    <div class="value text-danger" id="blockedUsers">0</div>
                                    <div class="label">Blocked Users</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add New User Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-user-plus me-2"></i>Add New User</div>
                                <button class="btn btn-primary btn-sm" onclick="toggleAddUserForm()">
                                    <i class="fas fa-plus"></i> Add User
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="addUserForm" style="display: none;">
                            <form id="newUserForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" name="fullName" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" name="phoneNumber" required
                                            pattern="[0-9]{10}" maxlength="10" minlength="10">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Email (Optional)</label>
                                        <input type="email" class="form-control" name="email">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Role</label>
                                        <select class="form-select" name="role" required>
                                            <option value="">Select Role</option>
                                            <option value="admin">Administrator</option>
                                            <option value="manager">Manager</option>
                                            <option value="user">User</option>
                                            <option value="stylist_only">Stylist Manager</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Location Access</label>
                                        <select class="form-select" name="location">
                                            <option value="all">All Locations</option>
                                            <option value="OJA OBA MARKET AKURE">OJA OBA MARKET AKURE</option>
                                            <option value="ONDO MARKET">ONDO MARKET</option>
                                            <option value="OJA OBA MARKET, ADO - EKITI">OJA OBA MARKET, ADO - EKITI
                                            </option>
                                            <option value="OJA TUNTUN, ILORIN">OJA TUNTUN, ILORIN</option>
                                            <option value="ORISUNBARE MARKET, OSOGBO">ORISUNBARE MARKET, OSOGBO</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" name="status">
                                            <option value="active">Active</option>
                                            <option value="pending">Pending Approval</option>
                                            <option value="blocked">Blocked</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Description/Notes</label>
                                        <textarea class="form-control" name="description" rows="2"></textarea>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-user-plus"></i> Add User
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="toggleAddUserForm()">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-users me-2"></i>System Users</div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshUsers()">
                                        <i class="fas fa-refresh"></i> Refresh
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="exportUsers()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <!-- Search and Filter -->
                            <div class="mt-3">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="userSearch"
                                            placeholder="Search users..." onkeyup="filterUsers()">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="roleFilter" onchange="filterUsers()">
                                            <option value="">All Roles</option>
                                            <option value="admin">Admin</option>
                                            <option value="manager">Manager</option>
                                            <option value="user">User</option>
                                            <option value="stylist_only">Stylist</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="statusFilter" onchange="filterUsers()">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="pending">Pending</option>
                                            <option value="blocked">Blocked</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="locationFilter" onchange="filterUsers()">
                                            <option value="">All Locations</option>
                                            <option value="all">All Access</option>
                                            <option value="OJA OBA MARKET AKURE">Akure</option>
                                            <option value="ONDO MARKET">Ondo</option>
                                            <option value="OJA OBA MARKET, ADO - EKITI">Ado-Ekiti</option>
                                            <option value="OJA TUNTUN, ILORIN">Ilorin</option>
                                            <option value="ORISUNBARE MARKET, OSOGBO">Osogbo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" onclick="clearUserFilters()">
                                            <i class="fas fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="usersTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Role</th>
                                            <th>Location Access</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">Loading users...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settings" class="dashboard-section" style="display: none;">
                    <h2 class="section-title">System Settings</h2>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cog me-2"></i> General Settings
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Business Name</label>
                                        <input type="text" class="form-control" value="Market Activation System"
                                            readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Default Currency</label>
                                        <select class="form-select">
                                            <option>Nigerian Naira (₦)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Time Zone</label>
                                        <select class="form-select">
                                            <option>West Africa Time (WAT)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-database me-2"></i> Data Management
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button class="btn btn-outline-primary w-100 mb-2">
                                            <i class="fas fa-download"></i> Export Data
                                        </button>
                                        <button class="btn btn-outline-success w-100 mb-2">
                                            <i class="fas fa-sync"></i> Sync with Google Sheets
                                        </button>
                                        <button class="btn btn-outline-warning w-100">
                                            <i class="fas fa-trash-alt"></i> Clear Sample Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <input type="hidden" id="changePasswordUserKey">
                        <div class="mb-3">
                            <label for="newPasswordInput" class="form-label">New Password *</label>
                            <input type="password" class="form-control" id="newPasswordInput" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPasswordInput" class="form-label">Confirm Password *</label>
                            <input type="password" class="form-control" id="confirmPasswordInput" required
                                minlength="6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">Update Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="forgotPasswordForm">
                        <div class="mb-3">
                            <label for="resetIdentifierInput" class="form-label">User ID or Phone Number *</label>
                            <input type="text" class="form-control" id="resetIdentifierInput" required
                                placeholder="Enter User ID or Phone Number">
                            <div class="form-text">Enter the User ID or phone number to reset password</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="resetPassword()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase Configuration

        const firebaseConfig = {
            apiKey: "AIzaSyCss4iZUFqOaQsJW-G5CT4WWPxxPjRXs4Y",
            authDomain: "market-activation.firebaseapp.com",
            databaseURL: "https://market-activation-default-rtdb.firebaseio.com",
            projectId: "market-activation",
            storageBucket: "market-activation.firebasestorage.app",
            messagingSenderId: "286226385972",
            appId: "1:286226385972:web:eafb6b1e5ecff6bfae8e61"
        };

        // Initialize Firebase
        var app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);

        // Firebase availability flag
        let firebaseAvailable = true;

        // Global stylists data for table display and customer form
        let stylistsData = [];
        let stylistsDataGlobal = [];

        // Test Firebase connectivity without authentication
        function testFirebaseConnectivity() {
            console.log('🔥 FIREBASE ONLY: Testing Firebase connectivity...');
            console.log('🌐 Database URL:', firebaseConfig.databaseURL);

            // Test with a simple write operation
            const testRef = database.ref('test_connection');
            const testData = {
                timestamp: new Date().toISOString(),
                test: 'connectivity_check'
            };

            return testRef.set(testData)
                .then(() => {
                    console.log('✅ Firebase connection test SUCCESSFUL - Location summary ready!');
                    firebaseAvailable = true;
                    return true;
                })
                .catch((error) => {
                    console.error('❌ Firebase connection test FAILED:', error.code, error.message);

                    // Check for common Firebase issues
                    if (error.code === 'PERMISSION_DENIED') {
                        console.warn('🔒 Firebase Database rules may be restricting access');
                        console.warn('💡 Solution: Set Firebase rules to allow read/write or add authentication');
                    } else if (error.code === 'NETWORK_ERROR') {
                        console.warn('🌐 Network connectivity issue');
                    }

                    firebaseAvailable = false;
                    return false;
                });
        }

        // Initialize Firebase and test connectivity - SINGLE CLEAN VERSION
        function initializeApp() {
            // Set document title
            document.title = 'Market Activation Dashboard';

            console.log('🚀 FIREBASE ONLY: Initializing Management Dashboard...');
            console.log('🔍 Firebase Available:', firebaseAvailable);
            console.log('📋 Firebase Database Rules Reminder:');
            console.log('   To allow data saving, set Firebase rules to:');
            console.log('   {');
            console.log('     "rules": {');
            console.log('       ".read": true,');
            console.log('       ".write": true');
            console.log('     }');
            console.log('   }');

            // Initialize dashboard features
            initializeDashboard();
            showAllSections();

            // Load stylists data which will trigger location summary table update
            console.log('📊 FIREBASE ONLY: Loading initial data...');
            loadStylists();

            // Test Firebase connectivity
            testFirebaseConnectivity();
        }

        // Initialize Firebase connectivity and start app
        testFirebaseConnectivity().then((connected) => {
            console.log('Firebase connectivity test completed:', connected ? '✅ Connected' : '❌ Using localStorage fallback');

            if (!connected) {
                console.log('');
                console.log('🔧 FIREBASE SETUP REQUIRED:');
                console.log('1. Go to Firebase Console: https://console.firebase.google.com/');
                console.log('2. Open your project: market-activation');
                console.log('3. Go to Realtime Database → Rules');
                console.log('4. Replace rules with:');
                console.log('   {');
                console.log('     "rules": {');
                console.log('       ".read": true,');
                console.log('       ".write": true');
                console.log('     }');
                console.log('   }');
                console.log('5. Click "Publish"');
                console.log('6. Refresh this page');
                console.log('');
            }

            // Initialize app regardless of Firebase status
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        });

        // Configuration
        const CONFIG = {
            enableBackend: true, // Firebase is enabled
            enableGoogleSheets: false, // Disabled Google Sheets
            requireOTPForForms: false, // Disabled OTP verification
            adminControlledAccess: false, // Disabled admin access control
            googleSheetsSheets: {
                users: 'Users',
                stylists: 'Stylists',
                customers: 'Customers',
                registrations: 'Registrations',
                otpLogs: 'OTP_Logs'
            }
        };

        // Local storage fallback functions
        function saveToLocal(key, data) {
            try {
                localStorage.setItem(`firebase_${key}`, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadFromLocal(key) {
            try {
                const data = localStorage.getItem(`firebase_${key}`);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        // Universal data operations (Firebase with localStorage fallback)
        function saveUserData(userKey, userData) {
            console.log('Attempting to save user data to:', firebaseAvailable ? 'Firebase' : 'localStorage');
            console.log('User key:', userKey, 'User data:', userData);

            if (firebaseAvailable) {
                return database.ref(`users/${userKey}`).set(userData)
                    .then(() => {
                        console.log('Successfully saved user data to Firebase');
                        return true;
                    })
                    .catch((error) => {
                        console.error('Firebase save error:', error.code || error.message);

                        // Check if it's a permission error
                        if (error.code === 'PERMISSION_DENIED') {
                            console.warn('Firebase permissions insufficient, switching to localStorage only');
                            firebaseAvailable = false;
                        }

                        // Fallback to localStorage if Firebase fails
                        const users = loadFromLocal('users') || {};
                        users[userKey] = userData;
                        saveToLocal('users', users);
                        console.log('Saved to localStorage as fallback');
                        return true;
                    });
            } else {
                const users = loadFromLocal('users') || {};
                users[userKey] = userData;
                saveToLocal('users', users);
                console.log('Saved user data to localStorage');
                return Promise.resolve(true);
            }
        }

        function getUserData(userKey) {
            if (firebaseAvailable) {
                return database.ref(`users/${userKey}`).once('value').then(snapshot => snapshot.val());
            } else {
                const users = loadFromLocal('users') || {};
                return Promise.resolve(users[userKey] || null);
            }
        }

        function getAllUsers() {
            if (firebaseAvailable) {
                return database.ref('users').once('value').then(snapshot => snapshot.val() || {});
            } else {
                return Promise.resolve(loadFromLocal('users') || {});
            }
        }

        function deleteUserData(userKey) {
            if (firebaseAvailable) {
                return database.ref(`users/${userKey}`).remove();
            } else {
                const users = loadFromLocal('users') || {};
                delete users[userKey];
                saveToLocal('users', users);
                return Promise.resolve();
            }
        }

        function updateUserStatus(userKey, status) {
            if (firebaseAvailable) {
                return database.ref(`users/${userKey}/status`).set(status);
            } else {
                const users = loadFromLocal('users') || {};
                if (users[userKey]) {
                    users[userKey].status = status;
                    saveToLocal('users', users);
                }
                return Promise.resolve();
            }
        }

        // User roles and permissions (defined first)
        // Dashboard initialized directly without authentication







        // Show dashboard (simplified - no authentication)
        function showDashboard() {
            // Hide login page and show main dashboard
            const loginPage = document.getElementById('loginPage');
            const mainDashboard = document.getElementById('mainDashboard');

            if (loginPage) loginPage.style.display = 'none';
            if (mainDashboard) mainDashboard.style.display = 'flex';

            document.title = 'Market Activation Dashboard';

            // Initialize dashboard
            initializeDashboard();
            showAllSections();
        }

        // Show all sections (no role-based access control)
        function showAllSections() {
            // Show all sidebar links
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.style.display = 'flex';
            });

            // Show dashboard by default
            document.getElementById('dashboard').style.display = 'block';
        }

        // Show login page and hide dashboard
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainDashboard').style.display = 'none';
            document.title = 'Market Activation System - Login';
            clearLoginMessages();
        }

        // Simplified logout function (just refresh page)
        function logout() {
            if (confirm('Are you sure you want to refresh the page?')) {
                window.location.reload();
            }
        }

        // Universal save function for any collection - Firebase ONLY
        function saveToFirebaseAndLocal(collection, documentId, data) {
            console.log(`🔥 FIREBASE ONLY: Saving ${collection} data:`, data);

            if (firebaseAvailable) {
                return database.ref(`${collection}/${documentId}`).set(data)
                    .then(() => {
                        console.log(`✅ Successfully saved ${collection} data to Firebase`);
                        showAlert('Data saved to Firebase successfully!', 'success');
                        return true;
                    })
                    .catch((error) => {
                        console.error(`❌ Firebase save error for ${collection}:`, error.code || error.message);
                        showAlert('Failed to save data to Firebase. Please check connection.', 'danger');
                        throw error; // Don't use localStorage fallback
                    });
            } else {
                console.error('🚫 Firebase not available - data not saved');
                showAlert('Firebase connection required. Data not saved.', 'danger');
                return Promise.reject(new Error('Firebase not available'));
            }
        }

        // Simplified Stylist form submission function
        function submitStylistForm() {
            const form = document.getElementById('stylistForm');
            const formData = new FormData(form);
            const submitBtn = document.getElementById('registerStylistBtn');

            // Prevent double submission
            if (submitBtn.disabled) {
                console.log('Form submission already in progress, ignoring duplicate');
                return;
            }

            const stylistData = {
                stylistId: 'STY_' + Date.now(),
                stylistName: formData.get('stylistName'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email') || '',
                location: formData.get('stylistLocation') || '',
                bankName: formData.get('bankName') || '',
                bankAccountNumber: formData.get('bankAccountNumber') || '',
                stylistCode: formData.get('stylistCode') || '',
                registrationDate: new Date().toISOString(),
                status: 'active',
                submittedBy: 'System User',
                geoLocation: formData.get('geoLocation') || '',
                formType: 'stylist_registration'
            };

            console.log('Submitting stylist data:', stylistData);

            // Show loading state
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            submitBtn.disabled = true;

            // Save only to Firebase
            saveToFirebaseAndLocal('stylists', stylistData.stylistId, stylistData)
                .then(() => {
                    showAlert('Stylist registered successfully!', 'success');
                    form.reset();

                    // Clear all red borders and validation states
                    form.querySelectorAll('input').forEach(input => {
                        input.style.border = '';
                        input.setCustomValidity('');
                    });

                    // Hide any result divs
                    const resultDiv = document.getElementById('stylistResult');
                    if (resultDiv) {
                        resultDiv.style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error('Error submitting stylist form:', error);
                    showAlert('Failed to register stylist. Please try again.', 'error');
                })
                .finally(() => {
                    // Restore button state
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                });
        }

        // Initialize dashboard functionality - SINGLE CLEAN VERSION
        function initializeDashboard() {
            console.log('🔥 FIREBASE ONLY: Initializing dashboard components...');
            initializeEnhancedStylistForm();
            initializeCustomerForm();
            updateDashboardStats();
        }

        // Load and display stylists data - SINGLE CLEAN VERSION - Firebase ONLY
        function loadStylists() {
            console.log('🔥 FIREBASE ONLY: Loading FRESH stylists data...');
            const tbody = document.getElementById('stylistsTableBody');

            if (firebaseAvailable) {
                // CLEAR existing listener to prevent caching
                database.ref('stylists').off('value');

                // Use once() to get fresh data without caching
                database.ref('stylists').once('value', (snapshot) => {
                    const stylists = snapshot.val() || {};
                    const stylistsList = Object.entries(stylists);

                    console.log('📊 FRESH stylists loaded from Firebase:', stylistsList.length);
                    console.log('🗺 Sample fresh data:', stylistsList.slice(0, 1));

                    // Update global arrays for table display and customer form
                    stylistsData = stylistsList.map(([key, data]) => ({
                        id: key,
                        code: data.stylistCode,
                        name: data.stylistName,
                        phone: data.phoneNumber,
                        location: data.location,
                        date: data.registrationDate,
                        status: data.status || 'Active',
                        bankName: data.bankName,
                        bankAccount: data.bankAccountNumber
                    }));

                    stylistsDataGlobal = stylistsList.map(([key, data]) => ({
                        id: key,
                        stylistCode: data.stylistCode,
                        stylistName: data.stylistName,
                        stylistLocation: data.location,
                        phoneNumber: data.phoneNumber,
                        registrationDate: data.registrationDate,
                        status: data.status || 'Active'
                    }));

                    // Update stylist stats
                    const totalStylists = stylistsList.length;
                    const activeStylists = stylistsList.filter(([key, data]) => data.status === 'active').length;

                    document.getElementById('totalStylists').textContent = totalStylists;
                    document.getElementById('activeStylists').textContent = activeStylists;

                    // Calculate location counts for location summary table - DETAILED LOGGING
                    console.log('🏪 LOCATION SUMMARY: Calculating location counts from stylists...');
                    const locationCounts = {};
                    stylistsList.forEach(([key, data], index) => {
                        const location = data.location || 'Unknown';
                        locationCounts[location] = (locationCounts[location] || 0) + 1;

                        if (index < 5) { // Log first 5 stylists for debugging
                            console.log(`   Stylist ${index + 1}: ${data.stylistName} → Location: ${location}`);
                        }
                    });

                    console.log('📍 LOCATION SUMMARY: Final location counts:', locationCounts);
                    console.log('🔄 LOCATION SUMMARY: Calling updateLocationSummaryTable...');

                    // Update location summary table with calculated data
                    updateLocationSummaryTable(locationCounts);

                    // Populate stylist codes dropdown for customer form
                    updateStylistCodesDropdown(stylistsList);

                    if (stylistsList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No stylists registered yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = stylistsList.map(([key, data]) => `
                        <tr>
                            <td><span class="badge bg-primary">${data.stylistCode || 'N/A'}</span></td>
                            <td>${data.stylistName || 'N/A'}</td>
                            <td>${data.phoneNumber || 'N/A'}</td>
                            <td>${data.location || 'N/A'}</td>
                            <td>${new Date(data.registrationDate).toLocaleDateString() || 'N/A'}</td>
                            <td><span class="badge bg-success">${data.status || 'Active'}</span></td>
                            <td><span class="text-success">Good</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewStylist('${key}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editStylist('${key}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
            } else {
                // No localStorage fallback - Firebase required
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">🚫 Firebase connection required. Please check your connection and refresh.</td></tr>';
                console.error('🚫 Firebase not available - cannot load stylists');
            }
        }

        // Update stylist codes dropdown for customer form
        function updateStylistCodesDropdown(stylistsList) {
            const datalist = document.getElementById('stylishCodeDatalist');
            if (!datalist) return;

            datalist.innerHTML = stylistsList.map(([key, data]) =>
                `<option value="${data.stylistCode}" data-name="${data.stylistName}" data-location="${data.location}">${data.stylistCode} - ${data.stylistName}</option>`
            ).join('');
        }

        // Handle stylist code selection in customer form
        function initializeCustomerForm() {
            console.log('🔥 FIREBASE ONLY: Initializing customer form...');
            const stylistCodeInput = document.getElementById('customerStylishCodeInput');
            const stylistNameInput = document.querySelector('input[name="stylishName"]');
            const stylistLocationInput = document.getElementById('customerStylistLocation'); // Use specific ID
            const customerPhoneInput = document.querySelector('input[name="customerNumber"]');
            const customerForm = document.getElementById('geoForm');

            if (stylistCodeInput) {
                stylistCodeInput.addEventListener('input', function () {
                    const selectedCode = this.value;
                    const datalist = document.getElementById('stylishCodeDatalist');

                    // Find matching option
                    const option = datalist.querySelector(`option[value="${selectedCode}"]`);
                    if (option) {
                        const name = option.getAttribute('data-name');
                        const location = option.getAttribute('data-location');

                        if (stylistNameInput) stylistNameInput.value = name || '';
                        if (stylistLocationInput) stylistLocationInput.value = location || '';
                    }

                    // Also try to find from global data if datalist doesn't work
                    if (stylistsDataGlobal && stylistsDataGlobal.length > 0) {
                        const stylist = stylistsDataGlobal.find(s => s.stylistCode === selectedCode);
                        if (stylist) {
                            if (stylistNameInput) stylistNameInput.value = stylist.stylistName || '';
                            if (stylistLocationInput) stylistLocationInput.value = stylist.stylistLocation || '';
                        }
                    }
                });
            }

            // Add phone validation for customer form
            if (customerPhoneInput) {
                customerPhoneInput.addEventListener('blur', function () {
                    if (this.value.length === 11) {
                        if (!/^0[789][0-9]{9}$/.test(this.value)) {
                            this.style.border = '2px solid #dc3545';
                            this.setCustomValidity('Mobile number must start with 07, 08, or 09');
                            showAlert('Mobile number must start with 07, 08, or 09', 'warning');
                        } else {
                            this.style.border = '';
                            this.setCustomValidity('');
                        }
                    } else if (this.value.length > 0) {
                        this.style.border = '2px solid #dc3545';
                        this.setCustomValidity('Mobile number must be exactly 11 digits');
                    }
                });
            }

            // Handle customer form submission
            if (customerForm) {
                customerForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    submitCustomerForm();
                });
            }
        }

        // Check for duplicate customer phone number
        function checkCustomerPhoneDuplicate(phoneNumber) {
            const customerPhoneInput = document.querySelector('input[name="customerNumber"]');

            if (firebaseAvailable) {
                database.ref('customers').orderByChild('customerNumber').equalTo(phoneNumber).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            customerPhoneInput.style.border = '2px solid #dc3545';
                            customerPhoneInput.setCustomValidity('This mobile number is already registered as a customer');
                            showAlert('This mobile number is already registered as a customer', 'danger');
                        } else {
                            customerPhoneInput.style.border = '';
                            customerPhoneInput.setCustomValidity('');
                        }
                    })
                    .catch(error => {
                        console.warn('Could not check customer phone duplicate:', error);
                    });
            }
        }

        // Submit customer form
        function submitCustomerForm() {
            const form = document.getElementById('geoForm');
            const formData = new FormData(form);
            const submitBtn = document.getElementById('registerCustomerBtn');
            const customerNumber = formData.get('customerNumber');

            // Prevent double submission
            if (submitBtn.disabled) {
                console.log('Customer form submission already in progress');
                return;
            }

            // Check for duplicate customer phone before submission
            if (firebaseAvailable && customerNumber) {
                database.ref('customers').orderByChild('customerNumber').equalTo(customerNumber).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            showAlert('This mobile number is already registered as a customer', 'danger');
                            const phoneInput = document.querySelector('input[name="customerNumber"]');
                            phoneInput.style.border = '2px solid #dc3545';
                            return;
                        }

                        // If no duplicate, proceed with submission
                        proceedWithCustomerSubmission(form, formData, submitBtn);
                    })
                    .catch(error => {
                        console.warn('Could not check duplicate before submission:', error);
                        // Proceed anyway if check fails
                        proceedWithCustomerSubmission(form, formData, submitBtn);
                    });
            } else {
                proceedWithCustomerSubmission(form, formData, submitBtn);
            }
        }

        // Proceed with customer form submission
        function proceedWithCustomerSubmission(form, formData, submitBtn) {
            const customerData = {
                customerId: 'CUST_' + Date.now(),
                stylistCode: formData.get('stylishCode'),
                stylistName: formData.get('stylishName'),
                stylistLocation: formData.get('stylistLocation'),
                customerName: formData.get('customerName'),
                customerNumber: formData.get('customerNumber'),
                customerEmail: formData.get('customerEmail') || '',
                registrationDate: new Date().toISOString(),
                status: 'active',
                submittedBy: 'System User',
                formType: 'customer_registration'
            };

            console.log('Submitting customer data:', customerData);

            // Show loading state
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registering...';
            submitBtn.disabled = true;

            // Save to Firebase
            saveToFirebaseAndLocal('customers', customerData.customerId, customerData)
                .then(() => {
                    showAlert('Customer registered successfully!', 'success');
                    form.reset();

                    // Clear form validation states
                    form.querySelectorAll('input').forEach(input => {
                        input.style.border = '';
                        input.setCustomValidity('');
                    });
                })
                .catch((error) => {
                    console.error('Error submitting customer form:', error);
                    showAlert('Failed to register customer. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                });
        }

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuBtn && sidebar && sidebarOverlay) {
            mobileMenuBtn.addEventListener('click', function () {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            });

            sidebarOverlay.addEventListener('click', function () {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Navigation functionality (simplified)
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();

                const targetId = this.getAttribute('href').substring(1);

                // Close mobile menu if open
                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }

                // Remove active class from all links
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));

                // Add active class to clicked link
                this.classList.add('active');

                // Hide all sections
                document.querySelectorAll('.dashboard-section, .form-section').forEach(section => {
                    section.style.display = 'none';
                });

                // Show the selected section
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';

                    // Load specific section data
                    if (targetId === 'stylists') {
                        loadStylistsTable();
                    } else if (targetId === 'payments') {
                        loadPaymentsTable();
                    } else if (targetId === 'reports') {
                        loadReportsData();
                    }
                }
            });
        });

        // Show dashboard by default
        document.getElementById('dashboard').style.display = 'block';

        // Load stylists table
        function loadStylistsTable() {
            const tableBody = document.getElementById('stylistsTableBody');
            tableBody.innerHTML = '';

            if (stylistsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No stylists registered yet.</td></tr>';
                return;
            }

            stylistsData.forEach((stylist, index) => {
                // Calculate performance metrics
                const completedJobs = Math.floor(Math.random() * 50) + 10; // Sample data
                const rating = (Math.random() * 1.5 + 3.5).toFixed(1); // Random rating 3.5-5.0
                const earnings = (Math.random() * 100000 + 50000).toLocaleString(); // Sample earnings

                const statusColor = {
                    'Active': 'success',
                    'Inactive': 'secondary',
                    'Suspended': 'danger'
                }[stylist.status] || 'success';

                const row = `
                    <tr data-stylist="${JSON.stringify(stylist).replace(/"/g, '&quot;')}">
                        <td><span class="stylist-code">${stylist.code}</span></td>
                        <td>
                            <div>
                                <strong>${stylist.name}</strong>
                                <br><small class="text-muted">ID: ${stylist.code}</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                ${stylist.phone}
                                <br><small class="text-muted">Mobile</small>
                            </div>
                        </td>
                        <td><span class="location-badge">${stylist.location}</span></td>
                        <td>
                            <div>
                                ${new Date(stylist.date).toLocaleDateString()}
                                <br><small class="text-muted">${getDaysSince(stylist.date)} days ago</small>
                            </div>
                        </td>
                        <td><span class="badge bg-${statusColor}">${stylist.status}</span></td>
                        <td>
                            <div class="text-center">
                                <div><strong>${completedJobs}</strong> jobs</div>
                                <div class="text-warning">★ ${rating}</div>
                                <small class="text-muted">₦${earnings}</small>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewStylist(${index})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editStylist(${index})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStylist(${index})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update statistics
            updateStylistStats();
        }

        // Load payments table
        function loadPaymentsTable() {
            const tableBody = document.getElementById('paymentsTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading payments...</td></tr>';

            if (firebaseAvailable) {
                database.ref('customers').once('value').then(snapshot => {
                    const customers = snapshot.val() || {};
                    const customersList = Object.entries(customers);

                    tableBody.innerHTML = '';

                    if (customersList.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No payment records yet.</td></tr>';
                        return;
                    }

                    // Show only recent 50 records
                    const recentRecords = customersList.slice(-50).reverse();

                    recentRecords.forEach(([key, customer]) => {
                        const paymentStatus = customer.paymentStatus || 'pending';
                        const paymentAmount = customer.paymentAmount || 5000;
                        const statusClass = paymentStatus === 'paid' ? 'success' : 'warning';
                        const statusText = paymentStatus === 'paid' ? 'Completed' : 'Pending';

                        const row = `
                            <tr>
                                <td>${new Date(customer.registrationDate || Date.now()).toLocaleDateString()}</td>
                                <td>${customer.stylistName || 'N/A'}</td>
                                <td>${customer.customerName || 'N/A'}</td>
                                <td>Hair Braiding</td>
                                <td><strong>₦${paymentAmount.toLocaleString()}</strong></td>
                                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                                <td>Cash</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });

                    // Update payment statistics
                    updatePaymentStats(customersList);
                }).catch(error => {
                    console.error('Error loading payments:', error);
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading payment records</td></tr>';
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-warning">Firebase not available</td></tr>';
            }
        }

        // Update payment statistics
        function updatePaymentStats(customersList) {
            const totalCustomers = customersList.length;
            const paidCustomers = customersList.filter(([key, data]) => data.paymentStatus === 'paid').length;
            const pendingCustomers = totalCustomers - paidCustomers;
            const totalPaid = paidCustomers * 5000;
            const totalPending = pendingCustomers * 5000;

            // Update payment cards
            const totalPaidElement = document.getElementById('totalPaid');
            if (totalPaidElement) {
                totalPaidElement.textContent = '₦' + totalPaid.toLocaleString();
            }

            // Update pending payments if element exists
            const pendingPaymentsElement = document.getElementById('pendingPayments');
            if (pendingPaymentsElement) {
                pendingPaymentsElement.textContent = '₦' + totalPending.toLocaleString();
            }
        }

        // Helper functions
        function getLocationName(code) {
            const locations = {
                'A': 'OJA OBA MARKET AKURE',
                'B': 'ONDO MARKET',
                'C': 'OJA OBA MARKET, ADO - EKITI',
                'D': 'OJA TUNTUN, ILORIN',
                'E': 'ORISUNBARE MARKET, OSOGBO'
            };
            return locations[code] || '';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Insert at top of content area
            const contentArea = document.querySelector('.content-area');
            contentArea.insertBefore(alertDiv, contentArea.firstChild);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function refreshStylists() {
            loadStylistsTable();
            showAlert('Stylists list refreshed!', 'info');
        }

        // Helper function to calculate days since registration
        function getDaysSince(dateString) {
            const regDate = new Date(dateString);
            const today = new Date();
            const diffTime = Math.abs(today - regDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Update stylist statistics
        function updateStylistStats() {
            const total = stylistsData.length;
            const active = stylistsData.filter(s => s.status === 'Active').length;
            const locations = [...new Set(stylistsData.map(s => s.location))].length;
            const thisMonth = stylistsData.filter(s => {
                const regDate = new Date(s.date);
                const now = new Date();
                return regDate.getMonth() === now.getMonth() && regDate.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('totalStylists').textContent = total;
            document.getElementById('activeStylists').textContent = active;
            document.getElementById('totalLocations').textContent = locations;
            document.getElementById('newStylists').textContent = thisMonth;
        }

        // Filter stylists based on search and filter criteria
        function filterStylists() {
            const searchTerm = document.getElementById('stylistSearch').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const tableRows = document.querySelectorAll('#stylistsTableBody tr');

            tableRows.forEach(row => {
                if (row.cells.length === 1) return; // Skip empty state row

                const stylistData = JSON.parse(row.getAttribute('data-stylist'));
                const name = stylistData.name.toLowerCase();
                const code = stylistData.code.toLowerCase();
                const phone = stylistData.phone.toLowerCase();
                const location = stylistData.location;
                const status = stylistData.status;

                const matchesSearch = name.includes(searchTerm) || code.includes(searchTerm) || phone.includes(searchTerm);
                const matchesLocation = !locationFilter || location === locationFilter;
                const matchesStatus = !statusFilter || status === statusFilter;

                if (matchesSearch && matchesLocation && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('stylistSearch').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterStylists();
        }

        // Sort table function
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.getElementById('stylistsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.cells.length > 1);

            const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
            sortDirection[columnIndex] = direction;

            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();

                // Handle date sorting
                if (columnIndex === 4) {
                    aVal = new Date(aVal.split('\n')[0]);
                    bVal = new Date(bVal.split('\n')[0]);
                }

                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // View stylist details
        function viewStylist(index) {
            const stylist = stylistsData[index];
            const modal = `
                <div class="modal fade" id="stylistModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Stylist Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="userIdInput" class="form-label">User ID *</label>
                                        <input type="text" class="form-control" name="userId" id="userIdInput" required
                                            placeholder="Enter unique user ID">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="passwordInput" class="form-label">Password *</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" name="password" id="passwordInput" required
                                                minlength="6" placeholder="Enter password">
                                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6"><strong>Code:</strong> ${stylist.code}</div>
                                    <div class="col-6"><strong>Name:</strong> ${stylist.name}</div>
                                    <div class="col-6"><strong>Phone:</strong> ${stylist.phone}</div>
                                    <div class="col-6"><strong>Status:</strong> <span class="badge bg-success">${stylist.status}</span></div>
                                    <div class="col-12"><strong>Location:</strong> ${stylist.location}</div>
                                    <div class="col-12"><strong>Registration:</strong> ${new Date(stylist.date).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="editStylist(${index})" data-bs-dismiss="modal">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modal);
            const modalElement = new bootstrap.Modal(document.getElementById('stylistModal'));
            modalElement.show();

            document.getElementById('stylistModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Export stylists data with Firebase CUST_ID
        function exportStylists() {
            console.log('🔥 FIREBASE ONLY: Exporting stylists data...');

            if (!firebaseAvailable) {
                showAlert('Firebase connection required for export', 'danger');
                return;
            }

            // Get stylists data from Firebase with real CUST_ID
            database.ref('stylists').once('value').then((snapshot) => {
                const stylists = snapshot.val() || {};
                const stylistsArray = Object.entries(stylists).map(([key, data]) => ({ id: key, ...data }));

                if (stylistsArray.length === 0) {
                    showAlert('No stylists data available to export', 'warning');
                    return;
                }

                // Generate CSV with Firebase CUST_ID format
                let csvContent = "CUST_ID,Code,Name,Phone,Location,Registration Date,Status,Bank Name,Bank Account\n";

                stylistsArray.forEach((stylist) => {
                    const row = [
                        stylist.id, // Firebase key as CUST_ID (e.g., CUST_1764826487676)
                        stylist.stylistCode || 'N/A',
                        `"${stylist.stylistName || 'N/A'}"`,
                        stylist.phoneNumber || 'N/A',
                        `"${stylist.location || 'N/A'}"`,
                        stylist.registrationDate || 'N/A',
                        stylist.status || 'Active',
                        `"${stylist.bankName || 'N/A'}"`,
                        stylist.bankAccountNumber || 'N/A'
                    ].join(',');
                    csvContent += row + '\n';
                });

                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `stylists_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert(`Exported ${stylistsArray.length} stylists with Firebase CUST_ID successfully!`, 'success');

            }).catch((error) => {
                console.error('Error exporting stylists:', error);
                showAlert('Failed to export stylists data', 'danger');
            });
        }

        function editStylist(index) {
            const stylist = stylistsData[index];
            if (confirm(`Edit stylist: ${stylist.name}?`)) {
                // Simple edit - could be enhanced with a modal
                const newName = prompt('Enter new name:', stylist.name);
                const newPhone = prompt('Enter new phone:', stylist.phone);

                if (newName && newPhone) {
                    stylistsData[index].name = newName;
                    stylistsData[index].phone = newPhone;
                    loadStylistsTable();
                    showAlert('Stylist updated successfully!', 'success');
                }
            }
        }

        function deleteStylist(index) {
            const stylist = stylistsData[index];
            if (confirm(`Delete stylist: ${stylist.name}? This action cannot be undone.`)) {
                stylistsData.splice(index, 1);
                loadStylistsTable();
                showAlert('Stylist deleted successfully!', 'warning');
            }
        }

        function loadReportsData() {
            // Load revenue chart
            const ctx = document.getElementById('revenueChart');

            if (!ctx) {
                console.warn('Revenue chart canvas not found');
                return;
            }

            // Destroy existing chart if it exists and is a Chart instance
            if (window.revenueChart && typeof window.revenueChart.destroy === 'function') {
                window.revenueChart.destroy();
            }

            window.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Monthly Revenue (₦)',
                        data: [2.1, 2.8, 3.2, 3.8, 4.1, 4.5, 4.2, 4.8, 4.3, 4.7, 4.9, 5.2],
                        borderColor: '#4285F4',
                        backgroundColor: 'rgba(66, 133, 244, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '₦' + value + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'Revenue: ₦' + context.parsed.y + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Charts initialization - will be replaced with real data
        let locationChart = null;
        let dailyChart = null;

        // Initialize charts with dummy data first, then update with real data
        function initializeCharts() {
            // Location chart will be updated with real data
            const locationCtx = document.getElementById('locationChart');
            if (locationCtx) {
                locationChart = new Chart(locationCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Loading...'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#ddd']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: 'Braiding Distribution'
                            }
                        }
                    }
                });
            }

            // Daily chart will be updated with real data
            const dailyCtx = document.getElementById('dailyChart');
            if (dailyCtx) {
                dailyChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: ['Loading...'],
                        datasets: [{
                            label: 'Daily Registrations',
                            data: [0],
                            borderColor: '#4285F4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Daily Registration Progress'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Registrations'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update location chart with real customer data by location
        function updateLocationChart(locationCounts) {
            if (!locationChart) return;

            // Get real customer data for chart
            if (firebaseAvailable) {
                database.ref('customers').once('value').then(snapshot => {
                    const customers = snapshot.val() || {};
                    const customersArray = Object.values(customers);

                    // Count customers by stylist location (actual braiding data)
                    const customerLocationCounts = {};
                    customersArray.forEach(customer => {
                        const location = customer.stylistLocation || 'Unknown';
                        customerLocationCounts[location] = (customerLocationCounts[location] || 0) + 1;
                    });

                    const locations = Object.keys(customerLocationCounts);
                    const counts = Object.values(customerLocationCounts);

                    if (locations.length === 0) {
                        locationChart.data.labels = ['No data available'];
                        locationChart.data.datasets[0].data = [1];
                        locationChart.data.datasets[0].backgroundColor = ['#ddd'];
                    } else {
                        locationChart.data.labels = locations;
                        locationChart.data.datasets[0].data = counts;
                        locationChart.data.datasets[0].backgroundColor = [
                            '#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD',
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ];
                    }
                    locationChart.update();
                }).catch(error => {
                    console.error('Error updating location chart:', error);
                });
            }
        }

        // Update daily chart with real customer registration data
        function updateDailyChart(customersArray) {
            if (!dailyChart) return;

            // Get last 7 days
            const last7Days = [];
            const dailyCounts = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                last7Days.push(dateString);

                // Count actual customer registrations for this day
                const dayCount = customersArray.filter(customer => {
                    if (!customer.registrationDate && !customer.timestamp) return false;
                    const regDate = new Date(customer.registrationDate || customer.timestamp);
                    return regDate.toDateString() === date.toDateString();
                }).length;

                dailyCounts.push(dayCount);
            }

            dailyChart.data.labels = last7Days;
            dailyChart.data.datasets[0].data = dailyCounts;
            dailyChart.data.datasets[0].label = 'Daily Customer Registrations';
            dailyChart.update();
        }

        // Handle window resize
        window.addEventListener('resize', function () {
            if (locationChart) locationChart.resize();
            if (dailyChart) dailyChart.resize();
            if (window.revenueChart && typeof window.revenueChart.resize === 'function') {
                window.revenueChart.resize();
            }
        });

        // Enhanced Register Stylist Form Logic
        function initializeEnhancedStylistForm() {
            console.log('Initializing enhanced stylist form...');
            const form = document.getElementById('stylistForm');
            if (!form) return;

            const locationInput = form.elements['stylistLocation'];
            const codeInput = form.elements['stylistCode'];
            const phoneInput = form.elements['phoneNumber'];
            const bankInput = form.elements['bankAccountNumber'];
            const stylistNameInput = form.elements['stylistName'];
            const bankNameInput = form.elements['bankName'];
            const registerBtn = document.getElementById('registerStylistBtn');
            const resultDiv = document.getElementById('stylistResult');

            // Safety check - ensure all required elements exist
            if (!locationInput || !codeInput || !phoneInput || !bankInput ||
                !stylistNameInput || !bankNameInput || !registerBtn || !resultDiv) {
                console.warn('Some form elements not found, skipping enhanced form initialization');
                return;
            }

            let locations = [];
            let duplicateFound = false;

            // Auto-uppercase all text fields
            function setAutoUppercase() {
                form.querySelectorAll('input[type="text"]').forEach(function (input) {
                    if (input.name === 'bankName' || input.name === 'stylistName') {
                        input.addEventListener('input', function () {
                            this.value = this.value.replace(/[^A-Za-z ]/g, '');
                        });
                    }
                    input.addEventListener('input', function () {
                        this.value = this.value.toUpperCase();
                    });
                });
            }
            setAutoUppercase();

            // Input validation and restriction - DISABLED FOR TESTING
            function restrictInput(input, pattern) {
                // Validation disabled for clean testing
                console.log('Input validation disabled for testing');
                /*
                let lastValid = '';
                input.addEventListener('input', function () {
                    if (pattern && !pattern.test(input.value)) {
                        input.value = lastValid;
                    } else if (!input.checkValidity()) {
                        input.style.border = '2px solid #dc3545';
                    } else {
                        input.style.border = '';
                        lastValid = input.value;
                    }
                });
                */
            }

            // Apply input restrictions
            restrictInput(stylistNameInput, /^[A-Za-z ]*$/);
            restrictInput(phoneInput, /^[0-9]{0,11}$/);
            restrictInput(bankNameInput, /^[A-Za-z ]*$/);
            restrictInput(bankInput, /^[0-9]{0,10}$/);

            // Bank name validation
            bankNameInput.addEventListener('blur', function () {
                const bankName = this.value.trim();
                const bankAccount = bankInput.value.trim();
                if (bankName && bankAccount && bankAccount.length === 10) {
                    checkDuplicate('bank');
                }
            });

            // Bank name validation
            bankNameInput.addEventListener('blur', function () {
                const bankName = this.value.trim();
                const bankAccount = bankInput.value.trim();
                if (bankName && bankAccount && bankAccount.length === 10) {
                    checkDuplicate('bank');
                }
            });

            // Bank account validation
            bankInput.addEventListener('blur', function () {
                const bankAccount = this.value.trim();
                const bankName = bankNameInput.value.trim();
                if (bankAccount.length === 10 && bankName) {
                    checkDuplicate('bank');
                }
            });

            // Stylist code formatting - DISABLED FOR TESTING
            console.log('Stylist code validation disabled for testing');
            /*
            let lastValidCode = '';
            codeInput.addEventListener('input', function () {
                let v = codeInput.value.toUpperCase();
                if (v.length > 0 && !/^[A-Z]/.test(v[0])) {
                    codeInput.value = '';
                    codeInput.style.border = '2px solid #dc3545';
                    lastValidCode = '';
                    return;
                }
                if (v.length > 1) v = v[0] + v.slice(1).replace(/[^0-9]/g, '');
                if (v.length > 4) v = v.slice(0, 4);
                if (!/^([A-Z][0-9]{0,3})?$/.test(v)) {
                    codeInput.value = lastValidCode;
                    codeInput.style.border = '2px solid #dc3545';
                    return;
                }
                codeInput.value = v;
                if (!codeInput.checkValidity()) {
                    codeInput.style.border = '2px solid #dc3545';
                } else {
                    codeInput.style.border = '';
                    lastValidCode = v;
                }
            });
            */

            // Location validation
            function isLocationValid(val) {
                const datalist = document.getElementById('stylistLocationDatalist');
                if (!datalist) return true;
                for (let option of datalist.options) {
                    if (option.value === val) return true;
                }
                return false;
            }

            locationInput.addEventListener('blur', function () {
                // Location validation disabled for testing
                console.log('Location blur validation disabled');
                /*
                if (locationInput.value && !isLocationValid(locationInput.value)) {
                    locationInput.value = '';
                    locationInput.style.border = '2px solid #dc3545';
                    locationInput.setCustomValidity('Please select a location from the list.');
                } else {
                    locationInput.style.border = '';
                    locationInput.setCustomValidity('');
                }
                */
            });

            // Duplicate checking with Firebase backend
            let debounceTimers = { phone: null, bank: null, code: null };
            function checkDuplicate(field) {
                const phone = phoneInput.value.trim();
                const bank = bankInput.value.trim();
                const bankName = bankNameInput.value.trim();
                const code = codeInput.value.trim();
                const phoneLoader = document.getElementById('phoneLoader');
                const bankLoader = document.getElementById('bankLoader');
                const codeLoader = document.getElementById('stylistCodeLoader');

                if (field === 'phone' && phone.length === 11) {
                    if (phoneLoader) phoneLoader.style.display = 'inline';

                    // Check Firebase for duplicate phone
                    database.ref('stylists').orderByChild('phoneNumber').equalTo(phone).once('value')
                        .then(snapshot => {
                            if (phoneLoader) phoneLoader.style.display = 'none';
                            if (snapshot.exists()) {
                                phoneInput.style.border = '2px solid #dc3545';
                                showAlert('This phone number is already registered', 'danger');
                                duplicateFound = true;
                            } else {
                                phoneInput.style.border = '';
                                duplicateFound = false;
                            }
                        })
                        .catch(error => {
                            if (phoneLoader) phoneLoader.style.display = 'none';
                            console.warn('Could not check phone duplicate:', error);
                        });
                }

                if (field === 'code' && code.length === 4) {
                    if (codeLoader) codeLoader.style.display = 'inline';

                    // Check Firebase for duplicate stylist code
                    database.ref('stylists').orderByChild('stylistCode').equalTo(code).once('value')
                        .then(snapshot => {
                            if (codeLoader) codeLoader.style.display = 'none';
                            if (snapshot.exists()) {
                                codeInput.style.border = '2px solid #dc3545';
                                showAlert('This stylist code is already registered', 'danger');
                                duplicateFound = true;
                            } else {
                                codeInput.style.border = '';
                                duplicateFound = false;
                            }
                        })
                        .catch(error => {
                            if (codeLoader) codeLoader.style.display = 'none';
                            console.warn('Could not check code duplicate:', error);
                        });
                }

                if (field === 'bank' && bank.length === 10 && bankName) {
                    if (bankLoader) bankLoader.style.display = 'inline';

                    // Check Firebase for duplicate bank account with same bank name
                    database.ref('stylists').once('value')
                        .then(snapshot => {
                            if (bankLoader) bankLoader.style.display = 'none';
                            let duplicateBank = false;

                            if (snapshot.exists()) {
                                snapshot.forEach(child => {
                                    const data = child.val();
                                    if (data.bankAccountNumber === bank && data.bankName === bankName) {
                                        duplicateBank = true;
                                    }
                                });
                            }

                            if (duplicateBank) {
                                bankInput.style.border = '2px solid #dc3545';
                                showAlert(`Bank account ${bank} with ${bankName} is already registered`, 'danger');
                                duplicateFound = true;
                            } else {
                                bankInput.style.border = '';
                                duplicateFound = false;
                            }
                        })
                        .catch(error => {
                            if (bankLoader) bankLoader.style.display = 'none';
                            console.warn('Could not check bank duplicate:', error);
                        });
                }
            }

            // Attach duplicate check events
            // Phone input change detection - DISABLED FOR TESTING
            // phoneInput.addEventListener('input', function () {
            //     clearTimeout(debounceTimers.phone);
            //     debounceTimers.phone = setTimeout(() => checkDuplicate('phone'), 500);
            // });

            bankInput.addEventListener('input', function () {
                clearTimeout(debounceTimers.bank);
                debounceTimers.bank = setTimeout(() => checkDuplicate('bank'), 500);
            });

            codeInput.addEventListener('input', function () {
                clearTimeout(debounceTimers.code);
                debounceTimers.code = setTimeout(() => checkDuplicate('code'), 500);
            });

            // Form submission (simplified - no OTP required)
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                // Final validation
                let isValid = true;
                Array.from(form.elements).forEach(function (input) {
                    if ((input.tagName === 'INPUT') && !input.checkValidity()) {
                        input.style.border = '2px solid #dc3545';
                        isValid = false;
                    } else if (input.tagName === 'INPUT') {
                        input.style.border = '';
                    }
                });

                if (!isLocationValid(locationInput.value)) {
                    // Location validation disabled for testing
                    console.log('Location validation bypassed for testing');
                    // locationInput.style.border = '2px solid #dc3545';
                    // showStylistResult('Please select a valid location from the list.', 'danger');
                    // isValid = false;
                }

                if (duplicateFound) {
                    showStylistResult('Cannot register: Duplicate found.', 'danger');
                    isValid = false;
                }

                if (!isValid) return;

                // Submit form directly
                submitStylistForm();
            });

            function showStylistResult(message, type) {
                const resultDiv = document.getElementById('stylistResult');
                const alertDiv = resultDiv.querySelector('.alert');

                if (!message) {
                    resultDiv.style.display = 'none';
                    return;
                }

                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;
                resultDiv.style.display = 'block';
            }

        }

        // Initialize enhanced stylist form when dashboard loads
        function initializeDashboard() {
            console.log('🔥 FIREBASE ONLY: Initializing dashboard components...');
            initializeEnhancedStylistForm();
            initializeCustomerForm();
            updateDashboardStats();
        }

        // Load and display stylists data
        function loadStylists() {
            console.log('Loading stylists data...');
            const tbody = document.getElementById('stylistsTableBody');

            if (firebaseAvailable) {
                database.ref('stylists').on('value', (snapshot) => {
                    const stylists = snapshot.val() || {};
                    const stylistsList = Object.entries(stylists);

                    // Update stylist stats
                    const totalStylists = stylistsList.length;
                    const activeStylists = stylistsList.filter(([key, data]) => data.status === 'active').length;

                    document.getElementById('totalStylists').textContent = totalStylists;
                    document.getElementById('activeStylists').textContent = activeStylists;

                    // Populate stylist codes dropdown for customer form
                    updateStylistCodesDropdown(stylistsList);

                    if (stylistsList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan=\"8\" class=\"text-center text-muted\">No stylists registered yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = stylistsList.map(([key, data]) => `
                        <tr>
                            <td><span class=\"badge bg-primary\">${data.stylistCode || 'N/A'}</span></td>
                            <td>${data.stylistName || 'N/A'}</td>
                            <td>${data.phoneNumber || 'N/A'}</td>
                            <td>${data.location || 'N/A'}</td>
                            <td>${new Date(data.registrationDate).toLocaleDateString() || 'N/A'}</td>
                            <td><span class=\"badge bg-success\">${data.status || 'Active'}</span></td>
                            <td><span class=\"text-success\">Good</span></td>
                            <td>
                                <button class=\"btn btn-sm btn-outline-primary\" onclick=\"viewStylist('${key}')\">
                                    <i class=\"fas fa-eye\"></i> View
                                </button>
                                <button class=\"btn btn-sm btn-outline-warning\" onclick=\"editStylist('${key}')\">
                                    <i class=\"fas fa-edit\"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
            }
        }

        // Update stylist codes dropdown for customer form
        function updateStylistCodesDropdown(stylistsList) {
            const datalist = document.getElementById('stylishCodeDatalist');
            if (!datalist) return;

            datalist.innerHTML = stylistsList.map(([key, data]) =>
                `<option value=\"${data.stylistCode}\" data-name=\"${data.stylistName}\" data-location=\"${data.location}\">${data.stylistCode} - ${data.stylistName}</option>`
            ).join('');
        }

        // Handle stylist code selection in customer form
        function initializeCustomerForm() {
            console.log('🔥 FIREBASE ONLY: Initializing customer form...');
            const stylistCodeInput = document.getElementById('customerStylishCodeInput');
            const stylistNameInput = document.querySelector('input[name=\"stylishName\"]');
            const stylistLocationInput = document.querySelector('input[name=\"customerstylistLocation\"]');
            const customerPhoneInput = document.querySelector('input[name=\"customerNumber\"]');
            const customerForm = document.getElementById('geoForm');

            if (stylistCodeInput) {
                stylistCodeInput.addEventListener('input', function () {
                    const selectedCode = this.value;
                    const datalist = document.getElementById('stylishCodeDatalist');

                    // Find matching option
                    const option = datalist.querySelector(`option[value=\"${selectedCode}\"]`);
                    if (option) {
                        const name = option.getAttribute('data-name');
                        const location = option.getAttribute('data-location');

                        if (stylistNameInput) stylistNameInput.value = name || '';
                        if (stylistLocationInput) stylistLocationInput.value = location || '';
                    }
                });
            }

            // Add phone validation for customer form
            if (customerPhoneInput) {
                customerPhoneInput.addEventListener('blur', function () {
                    if (this.value.length === 11) {
                        if (!/^0[789][0-9]{9}$/.test(this.value)) {
                            this.style.border = '2px solid #dc3545';
                            this.setCustomValidity('Mobile number must start with 07, 08, or 09');
                            showAlert('Mobile number must start with 07, 08, or 09', 'warning');
                        } else {
                            this.style.border = '';
                            this.setCustomValidity('');
                        }
                    } else if (this.value.length > 0) {
                        this.style.border = '2px solid #dc3545';
                        this.setCustomValidity('Mobile number must be exactly 11 digits');
                    }
                });
            }

            // Handle customer form submission
            if (customerForm) {
                customerForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    submitCustomerForm();
                });
            }
        }

        // Submit customer form
        function submitCustomerForm() {
            const form = document.getElementById('geoForm');
            const formData = new FormData(form);
            const submitBtn = document.getElementById('registerCustomerBtn');

            // Prevent double submission
            if (submitBtn.disabled) {
                console.log('Customer form submission already in progress');
                return;
            }

            const customerData = {
                customerId: 'CUST_' + Date.now(),
                stylistCode: formData.get('stylishCode'),
                stylistName: formData.get('stylishName'),
                stylistLocation: formData.get('customerstylistLocation'),
                customerName: formData.get('customerName'),
                customerNumber: formData.get('customerNumber'),
                customerEmail: formData.get('customerEmail') || '',
                registrationDate: new Date().toISOString(),
                status: 'active',
                submittedBy: 'System User',
                formType: 'customer_registration'
            };

            console.log('Submitting customer data:', customerData);

            // Show loading state
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-2\"></i>Registering...';
            submitBtn.disabled = true;

            // Save to Firebase
            saveToFirebaseAndLocal('customers', customerData.customerId, customerData)
                .then(() => {
                    showAlert('Customer registered successfully!', 'success');
                    form.reset();

                    // Clear form validation states
                    form.querySelectorAll('input').forEach(input => {
                        input.style.border = '';
                        input.setCustomValidity('');
                    });
                })
                .catch((error) => {
                    console.error('Error submitting customer form:', error);
                    showAlert('Failed to register customer. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                });
        }

        // Load and display customer data
        function loadCustomers() {
            console.log('🔥 FIREBASE ONLY: Loading fresh customers data...');
            if (firebaseAvailable) {
                // Clear existing listener and get fresh data
                database.ref('customers').off();

                database.ref('customers').once('value', (snapshot) => {
                    const customers = snapshot.val() || {};
                    const customersList = Object.entries(customers);

                    console.log('✅ Fresh customers loaded from Firebase:', customersList.length);
                    console.log('💳 Sample customer payment data:', customersList.slice(0, 1).map(([key, data]) => ({
                        name: data.customerName,
                        status: data.paymentStatus,
                        amount: data.paymentAmount
                    })));

                    updateCustomerTable(customersList);
                    updateCustomerStats(customersList);
                }).catch(error => {
                    console.error('❌ Error loading customers:', error);
                });
            }
        }

        // Update customer table
        function updateCustomerTable(customersList) {
            const tbody = document.getElementById('customersTableBody');
            if (!tbody) return;

            if (customersList.length === 0) {
                tbody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center text-muted\">No customers registered yet</td></tr>';
                return;
            }

            tbody.innerHTML = customersList.map(([key, data]) => `
                <tr>
                    <td>${data.customerName || 'N/A'}</td>
                    <td>${data.customerNumber || 'N/A'}</td>
                    <td>${data.stylistCode || 'N/A'}</td>
                    <td>${data.stylistName || 'N/A'}</td>
                    <td>${data.stylistLocation || 'N/A'}</td>
                    <td>${new Date(data.registrationDate).toLocaleDateString() || 'N/A'}</td>
                    <td>
                        <button class=\"btn btn-sm btn-outline-primary\" onclick=\"viewCustomer('${key}')\">
                            <i class=\"fas fa-eye\"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update customer statistics
        function updateCustomerStats(customersList) {
            const totalCustomers = customersList.length;
            const today = new Date().toDateString();
            const todayCustomers = customersList.filter(([key, data]) =>
                new Date(data.registrationDate).toDateString() === today
            ).length;

            const totalCustomersEl = document.getElementById('totalCustomers');
            const todayCustomersEl = document.getElementById('todayCustomers');

            if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers;
            if (todayCustomersEl) todayCustomersEl.textContent = todayCustomers;
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            console.log('🔥 FIREBASE ONLY: Updating dashboard statistics...');
            if (firebaseAvailable) {
                // Update stylist count and location chart data
                database.ref('stylists').on('value', (snapshot) => {
                    const stylists = snapshot.val() || {};
                    const stylistsArray = Object.values(stylists);
                    const count = stylistsArray.length;
                    console.log('📊 Dashboard: Updated stylist count:', count);

                    const stylistElement = document.querySelector('.dashboard-section .value');
                    if (stylistElement) stylistElement.textContent = count;

                    // Update location chart with stylist location distribution
                    const locationCounts = {};
                    stylistsArray.forEach(stylist => {
                        const location = stylist.location || 'Unknown';
                        locationCounts[location] = (locationCounts[location] || 0) + 1;
                    });
                    updateLocationChart(locationCounts);

                    // Update location summary table
                    updateLocationSummaryTable(locationCounts);
                });

                // Update customer/braiding count, payment stats, and daily chart
                database.ref('customers').on('value', (snapshot) => {
                    const customers = snapshot.val() || {};
                    const customersArray = Object.values(customers);
                    const count = customersArray.length;
                    console.log('📊 Dashboard: FRESH customer count:', count);
                    console.log('💳 Fresh payment data sample:', customersArray.slice(0, 2).map(c => ({
                        name: c.customerName,
                        status: c.paymentStatus,
                        amount: c.paymentAmount
                    })));

                    const braidingElement = document.querySelector('.dashboard-section .row .col-md-3:nth-child(2) .value');
                    if (braidingElement) {
                        braidingElement.textContent = count;
                        console.log('✅ Updated customer count in dashboard:', count);
                    }                    // Calculate real total payment and paid/pending amounts from database
                    let totalPayment = 0;
                    let paidAmount = 0;
                    let pendingAmount = 0;

                    console.log('💰 Processing payment data for', customersArray.length, 'customers...');

                    customersArray.forEach((customer, index) => {
                        const amount = parseFloat(customer.paymentAmount) || 5000;
                        totalPayment += amount;

                        console.log(`Customer ${index + 1}:`, {
                            name: customer.customerName,
                            status: customer.paymentStatus,
                            amount: amount,
                            rawStatus: customer.paymentStatus
                        });

                        // Check for all variations of "Paid" status
                        const status = (customer.paymentStatus || '').toString().toLowerCase();
                        if (status === 'paid' || status === 'completed' || status === 'complete') {
                            paidAmount += amount;
                            console.log('✅ Counted as PAID:', amount);
                        } else {
                            pendingAmount += amount;
                            console.log('⏳ Counted as PENDING:', amount);
                        }
                    });

                    console.log('💰 Payment Summary:', {
                        total: totalPayment,
                        paid: paidAmount,
                        pending: pendingAmount
                    });

                    // Update payment displays with real calculated amounts
                    const totalPaymentElement = document.querySelector('.dashboard-section .row .col-md-3:nth-child(3) .value');
                    if (totalPaymentElement) {
                        totalPaymentElement.textContent = '₹' + totalPayment.toLocaleString();
                        console.log('📊 Updated total payment display:', totalPaymentElement.textContent);
                    }

                    const pendingPaymentElement = document.querySelector('.dashboard-section .row .col-md-3:nth-child(4) .value');
                    if (pendingPaymentElement) {
                        pendingPaymentElement.textContent = '₹' + pendingAmount.toLocaleString();
                        console.log('📊 Updated pending payment display:', pendingPaymentElement.textContent);
                    }

                    // Update daily chart with customer registration data
                    updateDailyChart(customersArray);

                    // Update location chart with real customer data (call it properly)
                    updateLocationChart();

                    console.log('🔄 Dashboard statistics update completed!');
                });
            } else {
                console.log('❌ Firebase not available for dashboard stats');
            }
        }

        // Update location summary table with real data
        function updateLocationSummaryTable(locationCounts) {
            console.log('updateLocationSummaryTable called with:', locationCounts);

            const tbody = document.querySelector('#locationSummary tbody');
            if (!tbody) {
                console.log('Location summary table not found - checking selector');
                console.log('Available tables:', document.querySelectorAll('table'));
                return;
            }

            console.log('Table found, updating with data...');

            // Clear existing rows
            tbody.innerHTML = '';

            // Always show loading first
            tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading location data...</td></tr>';

            // Get actual customer and payment data for each location
            if (firebaseAvailable) {
                Promise.all([
                    database.ref('customers').once('value'),
                    database.ref('stylists').once('value')
                ]).then(([customersSnapshot, stylistsSnapshot]) => {
                    console.log('Firebase data loaded for location summary');

                    const customers = customersSnapshot.val() || {};
                    const stylists = stylistsSnapshot.val() || {};
                    const customersArray = Object.values(customers);
                    const stylistsArray = Object.values(stylists);

                    console.log('Customers count:', customersArray.length);
                    console.log('Stylists count:', stylistsArray.length);
                    console.log('Location counts:', locationCounts);

                    // Clear loading message
                    tbody.innerHTML = '';

                    // If no location data, show all locations from database
                    if (Object.keys(locationCounts).length === 0) {
                        console.log('No location counts provided, generating from stylist data');
                        // Generate location counts from all stylists
                        const allLocationCounts = {};
                        stylistsArray.forEach(stylist => {
                            const location = stylist.location || 'Unknown';
                            allLocationCounts[location] = (allLocationCounts[location] || 0) + 1;
                        });
                        locationCounts = allLocationCounts;
                        console.log('Generated location counts:', locationCounts);
                    }

                    // Process each location with real data
                    Object.entries(locationCounts).forEach(([location, stylistCount]) => {
                        console.log(`Processing location: ${location}, stylists: ${stylistCount}`);

                        // Get customers for this location (via stylist location)
                        const locationCustomers = customersArray.filter(customer =>
                            customer.stylistLocation === location
                        );

                        // Get stylists for this location
                        const locationStylists = stylistsArray.filter(stylist =>
                            stylist.location === location
                        );

                        console.log(`Location ${location}: ${locationCustomers.length} customers, ${locationStylists.length} stylists`);

                        // Calculate actual braiding completed (customer count for this location)
                        const braidingCompleted = locationCustomers.length;

                        // Calculate days since first stylist registration in this location
                        let days = 0;
                        if (locationStylists.length > 0) {
                            const registrationDates = locationStylists
                                .map(stylist => new Date(stylist.registrationDate || stylist.timestamp))
                                .filter(date => !isNaN(date));

                            if (registrationDates.length > 0) {
                                const earliestDate = new Date(Math.min(...registrationDates));
                                const today = new Date();
                                days = Math.ceil((today - earliestDate) / (1000 * 60 * 60 * 24));
                            }
                        }

                        // Calculate actual payments for this location
                        let totalPayment = 0;
                        let paymentDone = 0;
                        let paymentPending = 0;

                        locationCustomers.forEach(customer => {
                            const amount = customer.paymentAmount || 5000;
                            totalPayment += amount;

                            if (customer.paymentStatus === 'Paid' || customer.paymentStatus === 'paid') {
                                paymentDone += amount;
                            } else {
                                paymentPending += amount;
                            }
                        });

                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${location}</td>
                            <td>${stylistCount}</td>
                            <td>${braidingCompleted}</td>
                            <td>${days}</td>
                            <td>₹${totalPayment.toLocaleString()}</td>
                            <td>₹${paymentDone.toLocaleString()}</td>
                            <td>₹${paymentPending.toLocaleString()}</td>
                        `;

                        console.log(`Added row for ${location}: ${stylistCount} stylists, ${braidingCompleted} braidings, ${days} days`);
                    });

                    // If still no data after processing, show message
                    if (Object.keys(locationCounts).length === 0) {
                        console.log('No location data available, showing default message');
                        const row = tbody.insertRow();
                        row.innerHTML = '<td colspan="7" class="text-center text-muted">No stylists registered yet. Register stylists to see location data.</td>';
                    }
                }).catch(error => {
                    console.error('Error fetching data for location summary:', error);
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading location data. Please refresh.</td></tr>';
                });
            } else {
                // Fallback if Firebase not available
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Backend connection not available.</td></tr>';
            }
        }

        // Handle CSV file upload for payment status updates
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!firebaseAvailable) {
                showAlert('Firebase connection required for CSV upload', 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    showAlert('Invalid CSV file format', 'danger');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                console.log('CSV Headers:', headers);

                // Verify CSV format
                const requiredHeaders = ['CUST_ID', 'Payment Status'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

                if (missingHeaders.length > 0) {
                    showAlert(`Missing required columns: ${missingHeaders.join(', ')}`, 'danger');
                    return;
                }

                // Process CSV data
                const updates = [];
                const mismatches = [];
                let processedCount = 0;

                // Get all existing customers from Firebase first
                database.ref('customers').once('value').then((snapshot) => {
                    const existingCustomers = snapshot.val() || {};
                    console.log('Existing customers:', Object.keys(existingCustomers).length);

                    // Process each CSV row
                    for (let i = 1; i < lines.length; i++) {
                        const data = lines[i].split(',').map(d => d.trim().replace(/^"|"$/g, ''));

                        if (data.length < headers.length) continue;

                        const custId = data[headers.indexOf('CUST_ID')];
                        const paymentStatus = data[headers.indexOf('Payment Status')];
                        const paymentAmount = data[headers.indexOf('Payment Amount')] || '5000';

                        if (custId && paymentStatus) {
                            // Check if customer exists in Firebase
                            if (existingCustomers[custId]) {
                                updates.push({
                                    custId: custId,
                                    paymentStatus: paymentStatus,
                                    paymentAmount: parseFloat(paymentAmount) || 5000,
                                    paymentDate: new Date().toISOString(),
                                    customerName: existingCustomers[custId].customerName
                                });
                            } else {
                                // Customer not found - add to mismatches
                                mismatches.push({
                                    custId: custId,
                                    paymentStatus: paymentStatus,
                                    paymentAmount: paymentAmount,
                                    reason: 'Customer ID not found in database'
                                });
                            }
                        }
                    }

                    console.log('Updates to process:', updates.length);
                    console.log('Mismatches found:', mismatches.length);

                    // Show mismatches in popup if any
                    if (mismatches.length > 0) {
                        showMismatchPopup(mismatches);
                    }

                    // Process valid updates
                    if (updates.length > 0) {
                        processPaymentUpdates(updates);
                    } else {
                        showAlert('No valid payment updates found in CSV', 'warning');
                    }

                }).catch((error) => {
                    console.error('Error reading existing customers:', error);
                    showAlert('Failed to process CSV file', 'danger');
                });

                // Reset file input
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // Process payment updates in batch
        function processPaymentUpdates(updates) {
            let successCount = 0;
            let errorCount = 0;

            const updatePromises = updates.map(update => {
                return database.ref(`customers/${update.custId}`).update({
                    paymentStatus: update.paymentStatus,
                    paymentAmount: update.paymentAmount,
                    paymentDate: update.paymentDate,
                    lastUpdated: new Date().toISOString()
                }).then(() => {
                    successCount++;
                    console.log(`Updated payment for ${update.customerName} (${update.custId})`);
                }).catch((error) => {
                    errorCount++;
                    console.error(`Failed to update ${update.custId}:`, error);
                });
            });

            Promise.all(updatePromises).then(() => {
                showAlert(`Payment status updated successfully! ✅ ${successCount} updated, ❌ ${errorCount} failed`, 'success');

                // Force refresh all dashboard data
                setTimeout(() => {
                    console.log('🔄 Force refreshing dashboard after payment updates...');
                    forceRefreshDashboard();
                }, 1000);

            }).catch((error) => {
                console.error('Batch update error:', error);
                showAlert('Some payment updates failed', 'warning');
            });
        }

        // Force refresh dashboard data
        function forceRefreshDashboard() {
            console.log('🔄 FORCE REFRESH: Clearing cache and reloading all dashboard data...');

            if (!firebaseAvailable) {
                console.log('❌ Firebase not available for refresh');
                return;
            }

            // Clear all Firebase listeners first
            database.ref().off(); // Clear all listeners

            console.log('🧹 All Firebase listeners cleared');

            // Add small delay then reload everything fresh
            setTimeout(() => {
                console.log('📊 Reloading dashboard stats...');
                updateDashboardStats();

                console.log('👥 Reloading customers...');
                loadCustomers();

                console.log('💼 Reloading stylists...');
                loadStylists();

                console.log('✅ Dashboard force refresh completed - all data should be fresh!');
            }, 1000);
        }        // Show mismatch popup table
        function showMismatchPopup(mismatches) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'mismatchModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                CSV Data Mismatches Found
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-warning mb-3">
                                <strong>${mismatches.length}</strong> rows could not be processed due to mismatches:
                            </p>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>CUST_ID</th>
                                            <th>Payment Status</th>
                                            <th>Payment Amount</th>
                                            <th>Issue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${mismatches.map(m => `
                                            <tr>
                                                <td><code>${m.custId}</code></td>
                                                <td>${m.paymentStatus}</td>
                                                <td>₹${m.paymentAmount}</td>
                                                <td><span class="text-danger">${m.reason}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportMismatches()">Export Mismatches</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            // Store mismatches for export
            window.currentMismatches = mismatches;

            modal.addEventListener('hidden.bs.modal', function () {
                modal.remove();
                delete window.currentMismatches;
            });
        }

        // Export mismatches as CSV
        function exportMismatches() {
            if (!window.currentMismatches) return;

            let csvContent = "CUST_ID,Payment Status,Payment Amount,Issue\n";
            window.currentMismatches.forEach(m => {
                csvContent += `${m.custId},${m.paymentStatus},${m.paymentAmount},"${m.reason}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `payment_mismatches_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Utility functions for customer and stylist management
        function viewStylist(key) {
            showAlert('Stylist details view not implemented yet', 'info');
        }

        function editStylist(key) {
            showAlert('Stylist edit functionality not implemented yet', 'info');
        }

        function viewCustomer(key) {
            showAlert('Customer details view not implemented yet', 'info');
        }

        function refreshStylists() {
            loadStylists();
            showAlert('Stylists data refreshed', 'success');
        }

        function refreshCustomers() {
            loadCustomers();
            showAlert('Customers data refreshed', 'success');
        }

        function exportCustomers() {
            console.log('🔥 FIREBASE ONLY: Exporting customers data...');

            // Get customers data from Firebase
            if (!firebaseAvailable) {
                showAlert('Firebase connection required for export', 'danger');
                return;
            }

            database.ref('customers').once('value').then((snapshot) => {
                const customers = snapshot.val() || {};
                const customersArray = Object.entries(customers).map(([key, data]) => ({ id: key, ...data }));

                if (customersArray.length === 0) {
                    showAlert('No customers data available to export', 'warning');
                    return;
                }

                // Generate CSV with Firebase CUST_ID format
                let csvContent = "CUST_ID,Customer Name,Phone,Stylist Code,Stylist Name,Stylist Location,Service Date,Payment Amount,Payment Status\n";

                customersArray.forEach((customer) => {
                    const row = [
                        customer.id, // Firebase key as CUST_ID (e.g., CUST_1764826487676)
                        `"${customer.customerName || 'N/A'}"`,
                        customer.customerNumber || 'N/A',
                        customer.stylistCode || 'N/A',
                        `"${customer.stylistName || 'N/A'}"`,
                        `"${customer.stylistLocation || 'N/A'}"`,
                        customer.registrationDate || 'N/A',
                        customer.paymentAmount || '5000',
                        customer.paymentStatus || 'Pending'
                    ].join(',');
                    csvContent += row + '\n';
                });

                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `customers_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert(`Exported ${customersArray.length} customers with CUST_ID successfully!`, 'success');

            }).catch((error) => {
                console.error('Error exporting customers:', error);
                showAlert('Failed to export customers data', 'danger');
            });
        }

        // Setup navigation handling
        function setupNavigation() {
            // Handle sidebar navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    const href = this.getAttribute('href');
                    if (href && href.startsWith('#')) {
                        const sectionId = href.substring(1);
                        showSection(sectionId);

                        // Update active nav link
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });
        }

        // Show specific section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section, .form-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show requested section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';

                // Load data based on section
                switch (sectionId) {
                    case 'stylists':
                        loadStylists();
                        break;
                    case 'customers':
                        loadCustomers();
                        break;
                    case 'dashboard':
                        updateDashboardStats();
                        break;
                }
            }
        }

        // Initialize navigation when page loads
        document.addEventListener('DOMContentLoaded', function () {
            setupNavigation();
            initializeCharts(); // Initialize charts with loading state
            updateDashboardStats(); // Update dashboard statistics and charts with real data

            // Add refresh button to dashboard after page loads
            setTimeout(() => {
                addRefreshButtonToDashboard();
            }, 2000);
        });

        // Add refresh button to dashboard
        function addRefreshButtonToDashboard() {
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection && !document.getElementById('dashboardRefreshBtn')) {
                const refreshBtn = document.createElement('button');
                refreshBtn.id = 'dashboardRefreshBtn';
                refreshBtn.className = 'btn btn-primary btn-sm mb-3';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Dashboard';
                refreshBtn.onclick = () => {
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                    forceRefreshDashboard();
                    setTimeout(() => {
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Dashboard';
                        showAlert('Dashboard refreshed with latest data!', 'success');
                    }, 2000);
                };

                // Add button at the top of dashboard
                const firstChild = dashboardSection.firstElementChild;
                if (firstChild) {
                    dashboardSection.insertBefore(refreshBtn, firstChild);
                } else {
                    dashboardSection.appendChild(refreshBtn);
                }
            }
        }

        // Form OTP Verification State
        let formOTPState = {
            stylist: {
                phone: null,
                verified: false,
                otpSent: false,
                timer: null,
                confirmationResult: null
            },
            customer: {
                phone: null,
                verified: false,
                otpSent: false,
                timer: null,
                confirmationResult: null
            }
        };

        function verifyFormOTP(formType) {
            const otpInput = document.getElementById(`${formType}OTPCode`);
            const otpValue = otpInput.value.trim();

            if (otpValue.length !== 6) {
                showAlert('Please enter a 6-digit OTP', 'warning');
                return;
            }

            // Show loading state
            const verifyBtn = document.getElementById(`verify${formType.charAt(0).toUpperCase() + formType.slice(1)}OTP`);
            if (verifyBtn) {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            }

            // Use Firebase OTP verification if available
            if (formOTPState[formType].confirmationResult) {
                formOTPState[formType].confirmationResult.confirm(otpValue)
                    .then((result) => {
                        // OTP verified successfully
                        formOTPState[formType].verified = true;

                        // Hide OTP section and show verified badge
                        document.getElementById(`${formType}OTPSection`).style.display = 'none';
                        document.getElementById(`${formType}PhoneVerified`).style.display = 'block';

                        // Clear timer
                        if (formOTPState[formType].timer) {
                            clearInterval(formOTPState[formType].timer);
                        }

                        showAlert('Phone number verified successfully!', 'success');
                        console.log('Firebase OTP verification successful:', result.user);
                    })
                    .catch((error) => {
                        console.error('Firebase OTP verification error:', error);
                        showAlert('Invalid OTP. Please try again.', 'danger');
                        otpInput.focus();
                    })
                    .finally(() => {
                        if (verifyBtn) {
                            verifyBtn.disabled = false;
                            verifyBtn.innerHTML = 'Verify OTP';
                        }
                    });
            } else {
                // Fallback: Use demo OTP only if Firebase is not available
                const isValid = otpValue === '123456'; // Demo OTP for testing when Firebase is unavailable

                if (isValid) {
                    formOTPState[formType].verified = true;

                    // Hide OTP section and show verified badge
                    document.getElementById(`${formType}OTPSection`).style.display = 'none';
                    document.getElementById(`${formType}PhoneVerified`).style.display = 'block';

                    // Clear timer
                    if (formOTPState[formType].timer) {
                        clearInterval(formOTPState[formType].timer);
                    }

                    showAlert('Phone number verified successfully! (Demo mode)', 'success');
                } else {
                    showAlert('Invalid OTP. Please try again.', 'danger');
                    otpInput.focus();
                }

                if (verifyBtn) {
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = 'Verify OTP';
                }
            }
        }

        function startFormOTPTimer(formType) {
            let timeLeft = 60;
            const timerSpan = document.getElementById(`${formType}OTPTimer`);
            const resendBtn = document.getElementById(`resend${formType.charAt(0).toUpperCase() + formType.slice(1)}OTP`);

            if (resendBtn) {
                resendBtn.disabled = true;
                resendBtn.style.opacity = '0.6';
            }

            formOTPState[formType].timer = setInterval(() => {
                timeLeft--;
                if (timerSpan) {
                    timerSpan.textContent = `(${timeLeft}s)`;
                }

                if (timeLeft <= 0) {
                    clearInterval(formOTPState[formType].timer);
                    if (timerSpan) timerSpan.textContent = '';
                    if (resendBtn) {
                        resendBtn.disabled = false;
                        resendBtn.style.opacity = '1';
                    }
                }
            }, 1000);
        }

        function resendFormOTP(formType) {
            const phone = formOTPState[formType].phone;
            if (phone) {
                sendFormOTP(formType, phone);
            }
        }

        // Phone number validation and OTP trigger for forms
        function setupFormOTPValidation() {
            // Stylist form phone validation
            const stylistPhone = document.getElementById('phoneNumber');
            if (stylistPhone) {
                stylistPhone.addEventListener('blur', function () {
                    const phone = this.value.trim();
                    if (phone.length === 11 && /^0[789][0-9]{9}$/.test(phone)) {
                        if (!formOTPState.stylist.verified || formOTPState.stylist.phone !== phone) {
                            // Reset verification state for new number
                            formOTPState.stylist.verified = false;
                            document.getElementById('stylistPhoneVerified').style.display = 'none';

                            // Send OTP after short delay
                            setTimeout(() => {
                                // sendFormOTP('stylist', phone);
                            }, 500);
                        }
                    }
                });
            }

            // Customer form phone validation
            const customerPhone = document.querySelector('input[name="customerNumber"]');
            if (customerPhone) {
                customerPhone.addEventListener('blur', function () {
                    const phone = this.value.trim();
                    if (phone.length === 11 && /^0[789][0-9]{9}$/.test(phone)) {
                        if (!formOTPState.customer.verified || formOTPState.customer.phone !== phone) {
                            // Reset verification state for new number
                            formOTPState.customer.verified = false;
                            document.getElementById('customerPhoneVerified').style.display = 'none';

                            // Send OTP after short delay
                            setTimeout(() => {
                                // sendFormOTP('customer', phone);
                            }, 500);
                        }
                    }
                });
            }

            // Setup OTP verify buttons
            const verifyStylistBtn = document.getElementById('verifyStylistOTP');
            if (verifyStylistBtn) {
                verifyStylistBtn.addEventListener('click', () => verifyFormOTP('stylist'));
            }

            const verifyCustomerBtn = document.getElementById('verifyCustomerOTP');
            if (verifyCustomerBtn) {
                verifyCustomerBtn.addEventListener('click', () => verifyFormOTP('customer'));
            }

            // Setup resend OTP buttons
            const resendStylistBtn = document.getElementById('resendStylistOTP');
            if (resendStylistBtn) {
                resendStylistBtn.addEventListener('click', () => resendFormOTP('stylist'));
            }

            const resendCustomerBtn = document.getElementById('resendCustomerOTP');
            if (resendCustomerBtn) {
                resendCustomerBtn.addEventListener('click', () => resendFormOTP('customer'));
            }
        }

        // Form validation with OTP check
        function validateFormWithOTP(formType) {
            // OTP validation disabled for testing
            console.log(`OTP validation disabled for ${formType} form`);
            return true;
        }

        // Enhanced form submission validation
        function setupEnhancedFormValidation() {
            // Form validation setup - event listener removed to prevent duplicates
            const stylistForm = document.getElementById('stylistForm');
            if (stylistForm) {
                console.log('Stylist form validation setup completed (event listener in initializeEnhancedStylistForm)');
            }

            // Customer form validation
            const customerForm = document.getElementById('geoForm');
            if (customerForm) {
                customerForm.addEventListener('submit', function (e) {
                    // Skip OTP validation for testing
                    console.log('Customer form submission - OTP validation disabled');
                });
            }
        }

        // Firebase Authentication Functions
        let recaptchaVerifier = null;
        let confirmationResult = null;
        let otpCountdown = null;

        function initializeFirebase() {
            try {
                // Firebase is already initialized at the top of the script
                // No need for additional reCAPTCHA setup for username/password login
                // reCAPTCHA will be initialized only when needed for OTP verification
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showAlert('Failed to initialize authentication system', 'danger');
            }
        }

        // Initialize reCAPTCHA only when needed for OTP verification
        function initializeRecaptcha() {
            if (recaptchaVerifier) {
                return Promise.resolve();
            }

            try {
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('reCAPTCHA solved');
                    },
                    'expired-callback': () => {
                        console.log('reCAPTCHA expired');
                        showAlert('reCAPTCHA expired. Please try again.', 'warning');
                    }
                });
                return recaptchaVerifier.render();
            } catch (error) {
                console.error('reCAPTCHA initialization error:', error);
                return Promise.reject(error);
            }
        }

        function sendOTP() {
            const phoneInput = document.getElementById('phoneNumber');
            const phoneNumber = phoneInput.value.trim();

            if (!phoneNumber) {
                showAlert('Please enter a phone number', 'warning');
                phoneInput.focus();
                return;
            }

            if (phoneNumber.length !== 10) {
                showAlert('Please enter a valid 10-digit phone number', 'warning');
                phoneInput.focus();
                return;
            }

            const fullPhoneNumber = '+91' + phoneNumber;
            const sendOTPBtn = document.getElementById('sendOTPBtn');

            sendOTPBtn.disabled = true;
            sendOTPBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            // Initialize reCAPTCHA first, then send OTP
            initializeRecaptcha()
                .then(() => {
                    return firebase.auth(app).signInWithPhoneNumber(fullPhoneNumber, recaptchaVerifier);
                })
                .then((result) => {
                    confirmationResult = result;
                    showOTPForm();
                    startOTPCountdown();
                    showAlert('OTP sent successfully to your phone', 'success');
                    console.log('OTP sent to:', fullPhoneNumber);
                })
                .catch((error) => {
                    console.error('Error sending OTP:', error);
                    sendOTPBtn.disabled = false;
                    sendOTPBtn.innerHTML = 'Send OTP';

                    if (error.code === 'auth/too-many-requests') {
                        showAlert('Too many requests. Please try again later.', 'warning');
                    } else if (error.code === 'auth/invalid-phone-number') {
                        showAlert('Invalid phone number format', 'danger');
                    } else {
                        showAlert('Failed to send OTP. Please try again.', 'danger');
                    }

                    // Reset reCAPTCHA
                    if (recaptchaVerifier) {
                        recaptchaVerifier.clear();
                        initializeFirebase();
                    }
                });
        }

        function verifyOTP() {
            const otpCode = document.getElementById('otpCode').value.trim();

            if (!otpCode || otpCode.length !== 6) {
                showAlert('Please enter the 6-digit OTP code', 'warning');
                return;
            }

            const verifyOTPBtn = document.getElementById('verifyOTPBtn');
            verifyOTPBtn.disabled = true;
            verifyOTPBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            confirmationResult.confirm(otpCode)
                .then((result) => {
                    const user = result.user;
                    console.log('Phone authentication successful:', user.phoneNumber);

                    // Check if user is authorized
                    checkUserAuthorization(user.phoneNumber);
                })
                .catch((error) => {
                    console.error('Error verifying OTP:', error);
                    verifyOTPBtn.disabled = false;
                    verifyOTPBtn.innerHTML = 'Verify OTP';

                    if (error.code === 'auth/invalid-verification-code') {
                        showAlert('Invalid OTP code. Please try again.', 'danger');
                    } else if (error.code === 'auth/code-expired') {
                        showAlert('OTP code expired. Please request a new one.', 'warning');
                        console.log('Form reset');
                    } else {
                        showAlert('Failed to verify OTP. Please try again.', 'danger');
                    }
                });
        }

        function checkUserAuthorization(phoneNumber) {
            const userKey = phoneNumber.replace('+91', '');

            // Check in database for user permissions
            getUserData(userKey)
                .then((userData) => {
                    if (!userData) {
                        // User not found in database - deny access
                        showAlert('Access denied. Please contact administrator for account setup.', 'danger');
                        logout();
                        return;
                    }

                    if (userData.status !== 'active') {
                        const statusMessage = {
                            'pending': 'Your account is pending approval. Please contact administrator.',
                            'blocked': 'Your account has been blocked. Please contact administrator.',
                            'inactive': 'Your account is inactive. Please contact administrator.'
                        };

                        showAlert(statusMessage[userData.status] || 'Account access denied.', 'warning');
                        logout();
                        return;
                    }

                    // User authorized - proceed with login
                    completeLogin(userData);
                })
                .catch((error) => {
                    console.error('Error checking user authorization:', error);
                    showAlert('Unable to verify user permissions. Please try again.', 'danger');
                    logout();
                });
        }

        function completeLogin(userData) {
            // Store user session
            currentUser = {
                phone: userData.phoneNumber,
                name: userData.fullName,
                role: userData.role,
                location: userData.location,
                loginTime: new Date().toISOString()
            };

            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Update last login in database
            const userKey = userData.phoneNumber.replace('+91', '');
            getUserData(userKey).then((existingUser) => {
                if (existingUser) {
                    existingUser.lastLogin = new Date().toISOString();
                    return saveUserData(userKey, existingUser);
                }
            }).catch(error => {
                console.log('Could not update last login:', error);
            });

            // Hide login modal and show dashboard
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            loginModal.hide();

            updateUserDisplay();
            loadDashboard();

            showAlert(`Welcome back, ${userData.fullName}!`, 'success');
            console.log('Login completed for user:', currentUser);
        }

        function showOTPForm() {
            document.getElementById('phoneForm').style.display = 'none';
            document.getElementById('otpForm').style.display = 'block';
            document.getElementById('otpCode').focus();
        }



        function startOTPCountdown() {
            let timeLeft = 60;
            const resendLink = document.getElementById('resendOTP');

            otpCountdown = setInterval(() => {
                timeLeft--;
                resendLink.textContent = `Resend OTP (${timeLeft}s)`;

                if (timeLeft <= 0) {
                    clearInterval(otpCountdown);
                    resendLink.textContent = 'Resend OTP';
                    resendLink.style.pointerEvents = 'auto';
                    resendLink.style.opacity = '1';
                }
            }, 1000);

            resendLink.style.pointerEvents = 'none';
            resendLink.style.opacity = '0.6';
        }

        function resendOTP() {
            if (otpCountdown) return; // Still in countdown

            console.log('Form reset');
            setTimeout(() => {
                sendOTP();
            }, 500);
        }



        // User Management Functions
        function toggleAddUserForm() {
            const form = document.getElementById('addUserForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';

            if (form.style.display === 'block') {
                document.querySelector('input[name="fullName"]').focus();
            }
        }

        function addNewUser() {
            const form = document.getElementById('newUserForm');
            const formData = new FormData(form);

            const userData = {
                userId: formData.get('userId'),
                fullName: formData.get('fullName'),
                phoneNumber: '+91' + formData.get('phoneNumber'),
                email: formData.get('email') || '',
                password: formData.get('password'), // In production, this should be hashed
                role: formData.get('role'),
                location: formData.get('location'),
                status: formData.get('status'),
                description: formData.get('description') || '',
                createdDate: new Date().toISOString(),
                createdBy: currentUser?.name || 'System Admin',
                lastLogin: null,
                passwordChanged: false
            };

            // Validate required fields
            if (!userData.userId || !userData.fullName || !userData.phoneNumber || !userData.password || !userData.location) {
                showAlert('Please fill in all required fields', 'warning');
                return;
            }

            const userKey = userData.phoneNumber.replace('+91', '');
            const userId = userData.userId;

            // Check if user ID or phone number already exists
            Promise.all([
                getUserData(userKey),
                getUserByUserId(userId)
            ]).then(([existingUserByPhone, existingUserByUserId]) => {
                if (existingUserByPhone) {
                    showAlert('User with this phone number already exists', 'warning');
                    throw new Error('Phone number exists');
                }
                if (existingUserByUserId) {
                    showAlert('User ID already exists. Please choose a different one.', 'warning');
                    throw new Error('User ID exists');
                }

                // Submit to both Firebase and Google Sheets
                console.log('Saving user data:', userData);
                return Promise.all([
                    saveUserData(userKey, userData),
                    submitToGoogleSheets('users', userData)
                ]);
            })
                .then(() => {
                    showAlert('User added successfully', 'success');
                    form.reset();
                    toggleAddUserForm();
                    loadUsers();
                })
                .catch((error) => {
                    console.error('Error adding user:', error);
                    showAlert('Failed to add user. Please try again.', 'danger');
                });
        }

        // Enhanced data operations
        function getUserByUserId(userId) {
            if (firebaseAvailable) {
                return database.ref('users').orderByChild('userId').equalTo(userId).once('value')
                    .then(snapshot => {
                        const users = snapshot.val();
                        return users ? Object.values(users)[0] : null;
                    });
            } else {
                const users = loadFromLocal('users') || {};
                const foundUser = Object.values(users).find(user => user.userId === userId);
                return Promise.resolve(foundUser || null);
            }
        }

        // Google Sheets submission function
        function submitToGoogleSheets(sheetType, data) {
            console.log('Attempting to submit to Google Sheets:', sheetType, data);

            if (!CONFIG.enableGoogleSheets) {
                console.log('Google Sheets integration disabled');
                return Promise.resolve({ success: true, message: 'Sheets disabled' });
            }

            const payload = {
                action: 'submitData',
                sheetType: sheetType,
                sheetName: CONFIG.googleSheetsSheets[sheetType] || sheetType,
                data: data,
                timestamp: new Date().toISOString(),
                source: 'Management Dashboard'
            };

            console.log('Google Sheets payload:', payload);

            // If Google Apps Script URL is configured, make the actual request
            if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec') {
                console.log('Making request to Google Apps Script:', CONFIG.GOOGLE_SCRIPT_URL);
                return fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Handle CORS issues
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        console.log('Google Sheets request completed (no-cors mode)');
                        // With no-cors mode, we assume success if no error is thrown
                        return { success: true, message: 'Data submitted to Google Sheets' };
                    })
                    .catch(error => {
                        console.error('Error submitting to Google Sheets:', error);
                        // Don't fail the entire operation for Google Sheets errors
                        return { success: false, error: error.message, fallback: true };
                    });
            } else {
                // Simulate successful submission for demo
                console.log('Google Sheets URL not configured, using demo mode');
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('Demo Google Sheets submission completed');
                        resolve({ success: true, message: 'Data submitted to Google Sheets (Demo Mode)' });
                    }, 500);
                });
            }
        }        // Universal form submission function
        function submitFormData(formType, formData, additionalData = {}) {
            const submissionData = {
                ...formData,
                ...additionalData,
                submissionId: 'SUB_' + Date.now(),
                submittedAt: new Date().toISOString(),
                submittedBy: currentUser?.name || 'Anonymous',
                formType: formType
            };

            // Submit to both Firebase and Google Sheets
            const promises = [];

            // Firebase submission
            if (firebaseAvailable) {
                const ref = database.ref(`submissions/${formType}`).push();
                promises.push(ref.set(submissionData));
            } else {
                // Local storage fallback
                const submissions = loadFromLocal(`submissions_${formType}`) || [];
                submissions.push(submissionData);
                saveToLocal(`submissions_${formType}`, submissions);
                promises.push(Promise.resolve());
            }

            // Google Sheets submission
            promises.push(submitToGoogleSheets(formType, submissionData));

            return Promise.all(promises).then(() => {
                console.log(`${formType} form submitted successfully`);
                return { success: true, data: submissionData };
            }).catch(error => {
                console.error(`Error submitting ${formType} form:`, error);
                throw error;
            });
        }        // Password management functions
        function showChangePasswordModal(phoneKey) {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            document.getElementById('changePasswordUserKey').value = phoneKey;
            modal.show();
        }

        function changePassword() {
            const phoneKey = document.getElementById('changePasswordUserKey').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            if (!newPassword || newPassword.length < 6) {
                showAlert('Password must be at least 6 characters long', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'warning');
                return;
            }

            // Update user password
            getUserData(phoneKey).then(userData => {
                if (userData) {
                    userData.password = newPassword;
                    userData.passwordChanged = true;
                    userData.lastPasswordChange = new Date().toISOString();

                    return saveUserData(phoneKey, userData);
                }
            }).then(() => {
                showAlert('Password updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                document.getElementById('changePasswordForm').reset();
            }).catch(error => {
                console.error('Error updating password:', error);
                showAlert('Failed to update password', 'danger');
            });
        }

        function showForgotPasswordModal() {
            const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
            modal.show();
        }

        function resetPassword() {
            const identifier = document.getElementById('resetIdentifierInput').value;

            if (!identifier) {
                showAlert('Please enter User ID or Phone Number', 'warning');
                return;
            }

            // Search for user by User ID or Phone Number
            getAllUsers().then(users => {
                const userEntries = Object.entries(users);
                const foundUser = userEntries.find(([key, user]) =>
                    user.userId === identifier ||
                    user.phoneNumber === identifier ||
                    key === identifier.replace('+91', '')
                );

                if (!foundUser) {
                    showAlert('User not found', 'warning');
                    return;
                }

                const [userKey, userData] = foundUser;

                // Generate temporary password
                const tempPassword = 'Temp' + Math.random().toString(36).substring(2, 8);
                userData.password = tempPassword;
                userData.passwordChanged = false;
                userData.tempPasswordGenerated = new Date().toISOString();

                return saveUserData(userKey, userData).then(() => {
                    showAlert(`Temporary password generated: ${tempPassword}`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal')).hide();
                    document.getElementById('forgotPasswordForm').reset();
                });
            }).catch(error => {
                console.error('Error resetting password:', error);
                showAlert('Failed to reset password', 'danger');
            });
        }

        function loadUsers() {
            getAllUsers()
                .then((users) => {
                    displayUsers(Object.entries(users));
                    updateUserStats(users);
                })
                .catch((error) => {
                    console.error('Error loading users:', error);
                    showAlert('Failed to load users', 'danger');
                });
        }

        function displayUsers(userEntries) {
            const tbody = document.getElementById('usersTableBody');

            if (userEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = userEntries.map(([phoneKey, user]) => `
                <tr>
                    <td>${user.fullName}</td>
                    <td>${user.phoneNumber}</td>
                    <td>
                        <span class="badge bg-${getRoleBadgeColor(user.role)}">
                            ${USER_ROLES[user.role]?.name || user.role}
                        </span>
                    </td>
                    <td>${user.location === 'all' ? 'All Locations' : user.location}</td>
                    <td>
                        <span class="badge bg-${getStatusBadgeColor(user.status)}">
                            ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                        </span>
                    </td>
                    <td>${formatDate(user.createdDate)}</td>
                    <td>${user.lastLogin ? formatDate(user.lastLogin) : 'Never'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editUser('${phoneKey}', ${JSON.stringify(user).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="showChangePasswordModal('${phoneKey}')" 
                                title="Change Password">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-outline-${user.status === 'active' ? 'warning' : 'success'}" 
                                onclick="toggleUserStatus('${phoneKey}', '${user.status}')">
                                <i class="fas fa-${user.status === 'active' ? 'ban' : 'check'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteUser('${phoneKey}', '${user.fullName}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateUserStats(users) {
            const stats = {
                total: 0,
                active: 0,
                pending: 0,
                blocked: 0
            };

            Object.values(users).forEach(user => {
                stats.total++;
                if (user.status === 'active') stats.active++;
                else if (user.status === 'pending') stats.pending++;
                else if (user.status === 'blocked') stats.blocked++;
            });

            document.getElementById('totalUsers').textContent = stats.total;
            document.getElementById('activeUsers').textContent = stats.active;
            document.getElementById('pendingUsers').textContent = stats.pending;
            document.getElementById('blockedUsers').textContent = stats.blocked;
        }

        function getRoleBadgeColor(role) {
            const colors = {
                'super_admin': 'danger',
                'admin': 'primary',
                'manager': 'warning',
                'user': 'info',
                'stylist_only': 'secondary'
            };
            return colors[role] || 'secondary';
        }

        function getStatusBadgeColor(status) {
            const colors = {
                'active': 'success',
                'pending': 'warning',
                'blocked': 'danger',
                'inactive': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const locationFilter = document.getElementById('locationFilter').value;

            const rows = document.querySelectorAll('#usersTableBody tr');

            rows.forEach(row => {
                const cells = row.cells;
                if (cells.length < 8) return;

                const name = cells[0].textContent.toLowerCase();
                const phone = cells[1].textContent.toLowerCase();
                const role = cells[2].querySelector('span').textContent.toLowerCase();
                const location = cells[3].textContent;
                const status = cells[4].querySelector('span').textContent.toLowerCase();

                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesRole = !roleFilter || role.includes(roleFilter.toLowerCase());
                const matchesStatus = !statusFilter || status.includes(statusFilter);
                const matchesLocation = !locationFilter || location.includes(locationFilter);

                row.style.display = matchesSearch && matchesRole && matchesStatus && matchesLocation ? '' : 'none';
            });
        }

        function clearUserFilters() {
            document.getElementById('userSearch').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('locationFilter').value = '';
            filterUsers();
        }

        function refreshUsers() {
            showAlert('Refreshing user list...', 'info');
            loadUsers();
        }

        function exportUsers() {
            // This would typically export to CSV or Excel
            showAlert('Export functionality coming soon', 'info');
        }

        function toggleUserStatus(phoneKey, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'blocked' : 'active';

            if (confirm(`Are you sure you want to ${newStatus} this user?`)) {
                updateUserStatus(phoneKey, newStatus)
                    .then(() => {
                        showAlert(`User ${newStatus} successfully`, 'success');
                        loadUsers();
                    })
                    .catch((error) => {
                        console.error('Error updating user status:', error);
                        showAlert('Failed to update user status', 'danger');
                    });
            }
        }

        function editUser(phoneKey, userData) {
            // This would open a modal for editing user details
            showAlert('Edit user functionality coming soon', 'info');
        }

        function deleteUser(phoneKey, userName) {
            if (confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`)) {
                deleteUserData(phoneKey)
                    .then(() => {
                        showAlert('User deleted successfully', 'success');
                        loadUsers();
                    })
                    .catch((error) => {
                        console.error('Error deleting user:', error);
                        showAlert('Failed to delete user', 'danger');
                    });
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Test Firebase connectivity
            testFirebaseConnectivity().then(() => {
                console.log('Firebase connectivity test completed');
            });

            // Add form submission handlers
            const newUserForm = document.getElementById('newUserForm');
            if (newUserForm) {
                newUserForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    addNewUser();
                });
            }

            // Password toggle functionality
            const togglePasswordBtn = document.getElementById('togglePassword');
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', function () {
                    const passwordInput = document.getElementById('passwordInput');
                    const icon = this.querySelector('i');

                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.className = 'fas fa-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        icon.className = 'fas fa-eye';
                    }
                });
            }

            // Initialize application
            initializeApp();

            // Add CSV upload handler  
            const csvUpload = document.getElementById('csvUpload');
            if (csvUpload) {
                csvUpload.addEventListener('change', handleCSVUpload);
            }
        });

        // Google Apps Script Mobile Responsive Force Script
        (function () {
            'use strict';

            // Force mobile responsive behavior in GAS
            function forceGASMobileResponsive() {
                // Set proper viewport
                let viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                }

                // Force mobile styles
                const style = document.createElement('style');
                style.innerHTML = `
                    /* GAS Mobile Override */
                    @media screen and (max-width: 768px) {
                        body, html {
                            width: 100% !important;
                            max-width: 100% !important;
                            overflow-x: hidden !important;
                        }
                        
                        .container-fluid {
                            padding: 0 8px !important;
                        }
                        
                        .sidebar {
                            width: 100% !important;
                            max-width: 280px !important;
                        }
                        
                        .content-area {
                            margin-left: 0 !important;
                            width: 100% !important;
                        }
                        
                        .table-responsive {
                            overflow-x: auto !important;
                        }
                        
                        input, select, textarea {
                            font-size: 16px !important;
                        }
                    }
                `;
                document.head.appendChild(style);

                // Mobile detection and force mobile layout
                function isMobileDevice() {
                    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
                }

                if (isMobileDevice()) {
                    document.body.classList.add('mobile-device');

                    // Force responsive tables
                    const tables = document.querySelectorAll('.table');
                    tables.forEach(table => {
                        table.style.fontSize = '0.7rem';
                        table.style.width = '100%';
                    });

                    // Force responsive sidebar
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.style.transform = 'translateX(-100%)';
                    }

                    // Force mobile content area
                    const contentArea = document.querySelector('.content-area');
                    if (contentArea) {
                        contentArea.style.marginLeft = '0';
                        contentArea.style.width = '100%';
                        contentArea.style.padding = '10px';
                    }
                }

                // Window resize handler for GAS
                window.addEventListener('resize', function () {
                    if (isMobileDevice()) {
                        const contentArea = document.querySelector('.content-area');
                        if (contentArea) {
                            contentArea.style.marginLeft = '0';
                            contentArea.style.width = '100%';
                        }
                    }
                });
            }

            // Execute on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', forceGASMobileResponsive);
            } else {
                forceGASMobileResponsive();
            }

            // Execute after a short delay to ensure all elements are loaded
            setTimeout(forceGASMobileResponsive, 1000);
        })();

    </script>


    <span id="PING_IFRAME_FORM_DETECTION" style="display: none;"></span>
</body>

</html>